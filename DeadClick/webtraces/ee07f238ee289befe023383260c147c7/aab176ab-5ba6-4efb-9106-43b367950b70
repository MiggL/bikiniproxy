var Modal=function(){var c={},a={},d=document.createElement("div"),b=document.createElement("div"),f=document.createElement("div"),h=document.createElement("div"),k=document.createElement("div"),l,p;c.open=function(e){a.width=e.width||"auto";a.height=e.height||"auto";a.lock=e.lock||!1;a.hideClose=e.hideClose||!1;a.draggable=e.draggable||!1;a.closeAfter=e.closeAfter||0;a.closeCallback=e.closeCallback||!1;a.openCallback=e.openCallback||!1;a.hideOverlay=e.hideOverlay||!1;l=function(){c.center({})};e.content&& !e.ajaxContent?h.innerHTML=e.content:e.ajaxContent&&!e.content?(b.className="modal-loading",c.ajax(e.ajaxContent,function(a){h.innerHTML=a})):h.innerHTML="";b.style.width=a.width;b.style.height=a.height;c.center({});if(a.lock||a.hideClose)k.style.visibility="hidden";a.hideOverlay||(d.style.visibility="visible");b.style.visibility="visible";document.onkeypress=function(b){27===b.keyCode&&!0!==a.lock&&c.close()};k.onclick=function(){if(a.hideClose)return!1;c.close()};d.onclick=function(){if(a.lock)return!1; c.close()};window.addEventListener?window.addEventListener("resize",l,!1):window.attachEvent&&window.attachEvent("onresize",l);a.draggable?(f.style.cursor="move",f.onmousedown=function(a){c.drag(a);return!1}):f.onmousedown=function(){return!1};0<a.closeAfter&&(p=window.setTimeout(function(){c.close()},1E3*a.closeAfter));a.openCallback&&a.openCallback()};c.drag=function(a){var c=void 0!==window.event?window.event.clientX:a.clientX,m=void 0!==window.event?window.event.clientY:a.clientY,g=c-b.offsetLeft, d=m-b.offsetTop;document.onmousemove=function(a){c=void 0!==window.event?window.event.clientX:a.clientX;m=void 0!==window.event?window.event.clientY:a.clientY;b.style.left=0<c-g?c-g+"px":0;b.style.top=0<m-d?m-d+"px":0;document.onmouseup=function(){window.document.onmousemove=null}}};c.ajax=function(a,c){var d,g=!1,f=[function(){return new window.XMLHttpRequest},function(){return new window.ActiveXObject("Msxml2.XMLHTTP.6.0")},function(){return new window.ActiveXObject("Msxml2.XMLHTTP.3.0")},function(){return new window.ActiveXObject("Msxml2.XMLHTTP")}]; for(d=0;d<f.length;d+=1){try{g=f[d]()}catch(h){}if(!1!==g)break}g.open("GET",a,!0);g.onreadystatechange=function(){4===g.readyState&&(c(g.responseText),b.removeAttribute("class"))};g.send(null)};c.close=function(){h.innerHTML="";d.setAttribute("style","");d.style.cssText="";d.style.visibility="hidden";b.setAttribute("style","");b.style.cssText="";b.style.visibility="hidden";f.style.cursor="default";k.setAttribute("style","");k.style.cssText="";p&&window.clearTimeout(p);a.closeCallback&&a.closeCallback(); window.removeEventListener?window.removeEventListener("resize",l,!1):window.detachEvent&&window.detachEvent("onresize",l)};c.center=function(a){var c=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),f=Math.max(b.clientWidth,b.offsetWidth),g=Math.max(b.clientHeight,b.offsetHeight),h=0,k=0,l=0,n=0;"number"===typeof window.innerWidth?(h=window.innerWidth,k=window.innerHeight):document.documentElement&&document.documentElement.clientWidth&&(h=document.documentElement.clientWidth, k=document.documentElement.clientHeight);"number"===typeof window.pageYOffset?(n=window.pageYOffset,l=window.pageXOffset):document.body&&document.body.scrollLeft?(n=document.body.scrollTop,l=document.body.scrollLeft):document.documentElement&&document.documentElement.scrollLeft&&(n=document.documentElement.scrollTop,l=document.documentElement.scrollLeft);a.horizontalOnly||(b.style.top=n+k/2-g/2+"px");b.style.left=l+h/2-f/2+"px";d.style.height=c+"px";d.style.width="100%"};d.setAttribute("id","modal-overlay"); b.setAttribute("id","ZZZ123ABC");f.setAttribute("id","modal-header");h.setAttribute("id","modal-content");k.setAttribute("id","modal-close");f.appendChild(k);b.appendChild(f);b.appendChild(h);d.style.visibility="hidden";b.style.visibility="hidden";window.addEventListener?window.addEventListener("load",function(){document.body.appendChild(d);document.body.appendChild(b)},!1):window.attachEvent&&window.attachEvent("onload",function(){document.body.appendChild(d);document.body.appendChild(b)}); return c}();

  var destinationDomain = "https://secure.whatcounts.com/bin/listctrl";
  var script = document.getElementById('emailsignup');
  var triggerChoice = script.getAttribute('trigger');
  var eauthOwner = script.getAttribute('eauthowner');
  var sourceBrand = script.getAttribute('sourcebrand');
  var signUpButtonColor = script.getAttribute('signupbtnhexcolor');
  var whatCountsId = script.getAttribute('listidmaster');
  var dataTosend;
  var wcFormHtml = "<div class='vertical-alignment-helper'><form id='098customform789' onsubmit='return false'> <div style='background: #fff'> <div class=> <div class='form-group'> <div class='col-sm-12'> <h4 class='modal-title '> Newsletter Sign Up</h4> </div></div></div><div> <div class='form-group '> <div class='col-md-12'> <label for='1' class='control-label fb-required'='{' fb-required ':required}'>Email Address*</label> <input type='text' name='email'='inputText' validator-required='true' validator-group='' id='wc-email' class='form-control ' placeholder='Your email address here'> <p class='help-block '></p></div></div></div><div> <div class='form-group '> <div class='col-md-12'> <label>Zip Code</label> <input type='text' id='zip-check' placeholder='Your zip code here'> <p class='help-block '></p></div></div></div><div> <div class='form-group '> <div> <label>Internal Promotions:</label> <div class='checkbox'> <label class=''> <input type='checkbox' style='position:relative;left: 0;visibility:visible;' id='custom_eauth_internal_ind' checked name='- I prefer to receive internal offers and promotions' value='true'> - I prefer to receive internal offers and promotions </label> </div><div class='checkbox '> <label class=''> <input type='checkbox' id='custom_eauth_rent_ind' checked style='position:relative;left: 0;visibility:visible;' name='- I prefer to receive occasional updates with special offers from carefully selected third party partners' value='' class=' '> - I prefer to receive occasional updates with special offers from carefully selected third party partners </label> </div><p class='help-block '></p></div></div></div><div class='fb-form-object-editable'> <div class='form-group '> <div class='col-md-12'> <p class=''> By susbscribing, you agree to the terms and conditions of our <a target='_blank' style='color:" + signUpButtonColor + " ;'href='http://www.enthusiastnetwork.com/privacy/'>privacy policy.</a></p></div></div></div><div class='fb-form-object-editable'> <div class='form-group '> <div class='col-md-12'> <p class=''> *Required Fields</p></div></div></div><div class='fb-form-object-editable'> <div class='form-group '> <div class='col-md-12 '> <div class='pull-right'> <input id='wc-button' type='button' onclick='whatCountsSubscribe()' value='Sign Up' class='btn btn-success' style='background-color:" + signUpButtonColor + "'> </div></div></div></div></div></form>";
  var hashSubscribe = false;

	 //creating and adding some custom CSS
	var customStyleElement = document.createElement("STYLE");
	var modalStyles = document.createTextNode("#modal-overlay{background: #fff; filter: alpha(opacity=60); height: 100%; left: 0; -moz-opacity: 0.6; -webkit-opacity: 0.6; -ms-filter: alpha(opacity=60); opacity: 0.6; position: absolute; top: 0; width: 100%; z-index: 998;}#ZZZ123ABC #modal-close{cursor: pointer; display: block; filter: alpha(opacity=60); -moz-opacity: 0.6; -webkit-opacity: 0.6; -ms-filter: alpha(opacity=60); opacity: 0.6; float: right; height: 20px; width: 20px;}#modal-close:hover{filter: alpha(opacity=100); -moz-opacity: 1.0; -webkit-opacity: 1.0; -ms-filter: alpha(opacity=100); opacity: 1.0;}#ZZZ123ABC .btn,#ZZZ123ABC p{font-weight: 400; color: #626262;}#modal-overlay{background: rgba(0, 0, 0, .3) !important;}#ZZZ123ABC{box-sizing: border-box; display: block; background: #fff; border: 1px solid #ababab; box-shadow: 0 4px 16px rgba(0, 0, 0, .2); height: auto; padding: 10px; font-family: arial, sans-serif; font-size: 14px; position: absolute; z-index: 998;}#ZZZ123ABC > #modal-content{display: block; padding: 5px; z-index: 999; width: 100%; box-sizing: border-box;}#ZZZ123ABC > #modal-content form{box-sizing: border-box; display: block; width: 100%; line-height: 2em;}#ZZZ123ABC > #modal-content form .fb-form-object{box-sizing: border-box; display: block; width: 100%; position: relative;}#ZZZ123ABC p{display: block; line-height: 22px; margin: 0 0 10px; font-style: normal; white-space: normal; font-size: 13px;}#ZZZ123ABC > #modal-content form .fb-form-object .form-group > div{box-sizing: border-box; display: block; width: 100%;}#ZZZ123ABC .btn{display: inline-block; padding: 6px 17px; font-family: Arial, sans-serif; font-size: 14px; letter-spacing: .01em; -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; -webkit-font-feature-settings: ; margin-bottom: 0; border: 1px solid #f0f0f0; text-align: center; vertical-align: middle; cursor: pointer; border-radius: 3px; -webkit-border-radius: 3px; -moz-border-radius: 3px; background-image: none !important; background-color: #fff; text-shadow: none; box-shadow: none; line-height: 21px; position: relative; transition: color .1s linear 0s, background-color .1s linear 0s, opacity .2s linear 0s !important;}#ZZZ123ABC .btn-success,.btn-success:focus{color: #fff; background-color: #10cfbd;}#ZZZ123ABC .pull-right{float: right !important;}#ZZZ123ABC .btn-success.hover,.btn-success:hover,.open .dropdown-toggle.btn-success{color: #fff;}#ZZZ123ABC > #modal-content form .fb-form-object .form-group > div label{-webkit-font-smoothing: antialiased; box-sizing: border-box; color: #626262; cursor: default; display: inline-block; font-family: Montserrat; font-size: 11px; font-weight: 600; height: 20px; letter-spacing: .14px; line-height: 20px; margin-bottom: 5px; max-width: 100%; text-transform: uppercase;}#ZZZ123ABC > #modal-content form .fb-form-object .form-group{box-sizing: border-box; display: block; width: 100%;}#ZZZ123ABC #modal-header{height: 0; overflow: hidden; clear: both;}#ZZZ123ABC #modal-close:after{content: '+'; -webkit-transform: rotate(45deg); -moz-transform: rotate(45deg); -o-transform: rotate(45deg); -ms-transform: rotate(45deg); transform: rotate(45deg); height: 35px; width: 35px; position: absolute; font-size: 32px;}#ZZZ123ABC h4{font-size: 18px; margin: 5px auto; color: #2c2c2c; line-height: 28px; font-weight: 400;}#ZZZ123ABC .form-group{width: 100%; box-sizing: border-box; display: block;}#ZZZ123ABC input[type='text']{display: block; width: 78%; background-color: #fff; background-image: none; border: 1px solid rgba(0, 0, 0, .07); font-family: Arial, sans-serif; -webkit-appearance: none; color: #2c2c2c; outline: 0; height: 35px; padding: 0 12px; line-height: normal; font-size: 14px; font-weight: 400; vertical-align: middle; min-height: 35px; -webkit-box-shadow: none; box-shadow: none; border-radius: 2px; -webkit-border-radius: 2px; -moz-border-radius: 2px; -webkit-transition: background .2s linear 0s; transition: background .2s linear 0s;}#ZZZ123ABC #zip-check{width: 45%;}@media only screen and (min-width: 320px){#ZZZ123ABC > #modal-content{width: 260px;}#ZZZ123ABC > #modal-content form .fb-form-object .form-group > div{position: relative;}#ZZZ123ABC input[type='text']{max-width: 220px;}}@media only screen and (min-width: 480px){#ZZZ123ABC > #modal-content{width: 380px;}#ZZZ123ABC input[type='text']{max-width: calc(100% - 24px);}#ZZZ123ABC > #modal-content form .fb-form-object .form-group > div{margin-bottom: 5px;}#ZZZ123ABC{border: 1px solid #f2f6f7 !important; border-radius: 3px;}}#ZZZ123ABC .col-md-12{overflow: auto;};");
	customStyleElement.appendChild(modalStyles);
  document.head.appendChild(customStyleElement);

  var customStyleElement2 = document.createElement("STYLE");
  var modalStyles2 = document.createTextNode("#ZZZ123ABC{position:fixed;}#custom_eauth_internal_ind, #custom_eauth_rent_ind{-webkit-appearance: checkbox; -moz-appearance: checkbox; -ms-appearance: checkbox} #wc-button{-webkit-appearance: none;}");
  customStyleElement2.appendChild(modalStyles2);
  document.head.appendChild(customStyleElement2);

  //this function was to fix a problem on one of TENs sites where the top was positioned too far down.
  //I inlined it to override the inline that's created by the Modal plugin
  function changeTopInlinePosition() {
    var element = document.getElementById('ZZZ123ABC');
    element.style.top = '10em';
    element.style.position = 'fixed';
    element.style.zIndex = '9999999999999';
  }

	function openModalForm() {
		  Modal.open({
		    content: wcFormHtml,
    		draggable: false,
        openCallback: function() {
            changeTopInlinePosition();
            if (hashSubscribe) {
              moveLeft();
            }

        },
        closeCallback: function () {
          removeSubscribeUrl();
        }
		  });
        addSubscribeToUrl();
	}


function FormatCurrentTime() {
  var fullDate = new Date();
  var twoDigitMonth = ((fullDate.getMonth().length+1) === 1)? (fullDate.getMonth()+1) :  + (fullDate.getMonth()+1);
  var now = + fullDate.getFullYear()  + "-" +  twoDigitMonth + "-" + fullDate.getDate();
  this.now = now;
}
function getData(){

      var userEmail = document.getElementById('wc-email').value;
      var userZip = document.getElementById('zip-check').value;
      var eauthRentInd = document.getElementById('custom_eauth_rent_ind').checked;
      var eauthInternalInd = document.getElementById('custom_eauth_internal_ind').checked;
      var time = new FormatCurrentTime();
      dataTosend = 'slid=' + whatCountsId  + '&cmd=subscribe&' + 'email=' + userEmail + '&custom_zip_code=' + userZip + '&custom_eauth_owner=' + eauthOwner + '&custom_source_brand=' + sourceBrand + '&custom_eauth_newsletter_dt=' + time.now;

        if (eauthRentInd) {
          dataTosend += '&custom_eauth_rent_ind=Y&custom_eauth_rent_dt=' + time.now;
        }
        if (eauthInternalInd) {
          dataTosend += '&custom_eauth_internal_ind=Y&custom_eauth_internal_dt=' + time.now;
        }
}

function validateEmail() {
  var email = document.getElementById('wc-email').value;
  var filter = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
  return filter.test(email);
}

function ajax2() {
      var request;
        getData();
      if(window.XMLHttpRequest) {
         request = new XMLHttpRequest();
      } else {
        console.log('XMLHTTP not supported in your IE browser!!! Using ActiveXObject instead!!!!');
        request = new ActiveXObject("Microsoft.XMLHTTP");
      }

        request.open('POST', destinationDomain, true);
        request.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01");
        request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
        request.send(dataTosend);
 }



 function whatCountsSubscribe() {
   if (validateEmail()) {

     ajax2();
     //Pop Up Thanks/Success Message and then disappear both
     hideFistModal();
     thankYouModal();
   } else {
     badEmailAlert();
     setTimeout(clearBadEmailAlert, 4000);
   }
 }

//Cookie stuffs

function cookieSet() {

        var whatCountsSubscribe = true ;

         currentTime = new Date(),
         //set 2 weeks(14 days away from current time to put in local storage)
         fortnightAway = currentTime.setDate(currentTime.getDate()+14),
         object = {whatCountsSubscribe: true, expiry: fortnightAway};
        // Put the object into storage
        localStorage.setItem('whatCounts', JSON.stringify(object));


}
function cookieGet(seconds) {
        // Retrieve the object from storage
        var retrievedObject = localStorage.getItem('whatCounts');
        var milliseconds = seconds * 1000;
        if (retrievedObject) {
                    retrievedObject = JSON.parse(retrievedObject),
                    expiryDate = retrievedObject.expiry,
                    now = new Date().getTime();
                    console.log(expiryDate + ' is expiryDate  ' + now + ' is now');
                    if (expiryDate <= now) {
                        setTimeout(openModalForm, milliseconds);
                        cookieSet();
                    } else {
                        console.log('cookie already set and not yet expired!');
                    }
        } else {
           setTimeout(openModalForm, milliseconds);
           cookieSet();
        }


}
//Hides the overlay and ZZZ123ABC 1 which is the thank you modal
function hideFistModal() {

        document.getElementById("ZZZ123ABC").style.visibility = "hidden";
}
//Hide the second modal and overlay at same time!
function hideSecondModal() {
        document.getElementById("ZZZ123ABC2").style.visibility = "hidden";
        document.getElementById("modal-overlay").style.visibility = "hidden";
        hideFistModal();
}
//pops up thank you and then hides the original
function thankYouModal() {

        Modal.open({
                    content: "<div id='ZZZ123ABC2'><h4>Thank You! Sign Up Successful!</h4> </div>",
                                draggable: true
                  });
          document.getElementById('ZZZ123ABC').style.position = 'fixed';
}

function badEmailAlert() {
  var helpP = document.getElementsByClassName("help-block ")[0];
  helpP.style.color = "red";
  helpP.innerHTML = "Please enter a valid email address!";

}
function clearBadEmailAlert() {
  var helpP = document.getElementsByClassName("help-block ")[0];
  helpP.innerHTML = '';
}

function modalTimer(seconds) {

        cookieGet(seconds);
}
function classOrId(triggerInput) {
  var hashTagId = triggerInput.indexOf("#");
  var periodClass= triggerInput.indexOf(".");
  if (hashTagId === -1 && periodClass === -1) {
    console.error('You have entered the trigger attribute in the <script> tag in the HTML incorrectly. Please prefix a class with a "." or an id with a "#"');
  } else {
    if (hashTagId > periodClass) {
      return true;
    } else {
      return false;
    }
  }
}

function targetButton(trigger) {

      var triggerButton;
      if (classOrId(trigger)) {

        triggerButton = document.getElementById(trigger.slice(1));
        triggerButton.setAttribute('onclick', 'openModalForm()');
      } else {
        triggerButton = document.getElementsByClassName(trigger.slice(1));

        triggerButton[0].setAttribute('onclick', 'openModalForm()');
      }
}
 targetButton(triggerChoice);

function moveLeft(){

      var element = document.getElementById('ZZZ123ABC');
      element.style.position = 'fixed';
      element.style.zIndex = '9999999999999';
      element.style.left = '35%';
      element.style.top = '5em';


}
 function checkForSubscribe(){
   var url = window.location.href;
   var keyword = '#subscribe';
   if (url.indexOf(keyword) > -1) {
    hashSubscribe = true;
     setTimeout(openModalForm, 2000);


   }
 }
 function addSubscribeToUrl() {

  window.location.hash= 'subscribe';
 }
 function removeSubscribeUrl(){
   var hash = window.location.hash;
   if(hash === '#subscribe')  {

    window.location.replace("#");
    if (typeof window.history.replaceState == 'function') {
        history.replaceState({}, '', window.location.href.slice(0, -1));
      }
   }
 }
function appendOpenInlineScript(){
 var myElement = document.createElement('SCRIPT');
 var node = document.createTextNode("checkForSubscribe();");
 myElement.appendChild(node);
 document.body.appendChild(myElement);
}
 checkForSubscribe();
