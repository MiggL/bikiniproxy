var _paq=_paq||[],CWApiHandler=CWApiHandler?CWApiHandler:{loadConfig:function(c){CWApiHandler.get(c)},loadComments:function(c){CWApiHandler.get(c)},get:function(c){CWUtils.ajax.get(c.url,c.data,function(a){c.success(a)},function(){c.error()})},post:function(c){CWUtils.ajax.post(c.url,c.data,function(a){c.success(a)},function(a){c.error(a)})},checkLogin:function(c){console.log(c);CwZ.ajax({type:"GET",url:c.url,success:function(a,e,b){c.success(a,e,b)},error:function(a){c.error(a)}})},loadContacts:function(c){CwZ.ajax({type:"GET",
url:c.url,success:function(a,e,b){c.success(a,e,b)},error:function(a){c.error(a)}})},loadGroups:function(c){CwZ.ajax({type:"GET",url:c.url,success:function(a,e,b){c.success(a,e,b)},error:function(a){c.error(a)}})},saveComments:function(c){CWApiHandler.post(c)},findPublication:function(c){CWApiHandler.post(c)},createPublication:function(c){CWApiHandler.post(c)},findFile:function(c){CWApiHandler.post(c)},getUploadParams:function(c){CwZ.ajax({url:c.url,data:c.data,type:"POST",success:function(a){c.success(a)},
error:function(){c.error()}})},findPubs:function(c){CWUtils.ajax.post(c.url,c.data,function(a,e,b){c.success(a,e,b)})},findPubsDOI:function(c){CWApiHandler.get(c)},getFileURL:function(c){CWUtils.ajax.get(c.url,c.data,c.success,c.error)},uploadFile:function(c){try{CWPDFReader.uploadFile(void 0!=c.data.blobLink?c.data.blobLink:c.data.pdfLink,c.data.index,{euId:c.data.euId,fileId:c.data.fileId})}catch(a){CWDataCenter.exceptionHandler(a)}},postToTracker:function(c){},injectPiwik:function(c){},trackPiwik:function(c){},
signoutCallToColwiz:function(c){CwZ.ajax({url:c.url,success:function(a){c.success(a)}})},uploadSync:function(c){CwZ.ajax({url:c.url,data:c.data,type:"POST",success:function(){c.success()}})},getState:function(){},setState:function(){}},CWData_Center=function(){function c(){this.pubSelected=this.blob=this.pubs=this.euId=this.eId=this.fileId=null;this.isReadOnly=this.isWorking=this.isLoginShown=this.isLogin=!1;this.tsCmt=0;this.bFindPubsChecked=!1;this.publisherOptions=null;this.trackerStamp=(new Date).getTime();
this.trackerID=(1E3*(new Date).getTime()+(Math.floor(200*Math.random())+100)).toString(16);this.bRavenConf=!1;this.myProfileLink="";this.loginChecked=!1;this.etArray={};this.lastSyncTS=null;this.comments={};this.piwikConfigured=!1;this.readerModePiwik="";this.isWebImporter=!1;this.PubsDoiUrlHash={}}c.prototype.resetVariables=function(){this.pubSelected=this.euId=this.eId=this.fileId=null;this.isReadOnly=!1;this.tsCmt=0;this.trackerStamp=(new Date).getTime();this.trackerID=(1E3*this.trackerStamp+(Math.floor(200*
Math.random())+100)).toString(16)};c.prototype.setPageMeta=function(a){this.pubs=a};c.prototype.signoutCallToColwiz=function(){var a=this,e={onSuccess:function(b){CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher&&CWPDFReader.logoutFromReaderCallback();CWUtils.log("signout successful.");a.isLogin=!1}};CWApiHandler.signoutCallToColwiz({url:CWPDFReaderConfig.cwURL+"/?signout",success:function(a){return e.onSuccess(a)}})};c.prototype.redirectToMyProfile=function(){window.open(this.myProfileLink,
"_blank")};c.prototype.setMetaData=function(a,e){try{this.pubs[e].data=a.data;var b=a.blobLink||a.data.blobLink,d=a.blobType||a.data.blobType;b&&(this.pubs[e].blobLink=b,this.pubs[e].blobType=d);this.pubSelected&&this.pubSelected.index===e&&(this.pubSelected.data=a.data)}catch(f){}CWTaskManager.process()};c.prototype.ajaxError=function(a){CWUtils.log("Error");CWUtils.log(a);switch(a.status){case 401:case 403:this.isLogin=!1;CWPDFReaderConfig.isDesktopMode()||CWPDFReader.showLoginFrame();CWPDFReader.hideSyncingDisplay();
break;case 0:CWPDFReader.logConsole("It looks like that your internet connection is lost. Kindly check your connection and reload your page.","Connection Lost",!0);break;case 503:CWPDFReader.logConsole("Server not found!"),CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||CWPDFReader.showServerDown()}};c.prototype.checkLogin=function(a,e){var b=this;b instanceof window.constructor&&(b=CWDataCenter);if(this.loginChecked)this.isLogin?a&&a():e&&e();else{var d=Math.floor((new Date).valueOf()/
1E3),d=CWPDFReaderConfig.isDesktopMode()?"app/data/user.json":CWPDFReaderConfig.cwURL+"/user?blocking=false&"+d;this.isWorking=!0;var f={onSuccess:function(f,d,c){b.loginChecked=!0;setTimeout(function(){b.loginChecked=!1},3E3);b.isWorking=!1;f=parseInt(f);CWUtils.log("data");CWUtils.log(f);if("success"===d&&0!==f){try{CWPDFReaderConfig.uId||b.loadConfig()}catch(n){}b.isLogin=!0;CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||(CWPDFReader.updateUser(CWDataCenter.isLogin),CWPDFReader.set_bLogin&&
CWPDFReader.set_bLogin(!0));a&&a()}else CWUtils.log(f),CWUtils.log("not logged in"),b.isLogin=!1,CWPDFReaderConfig.pbxURL=null,CWPDFReader.set_bLogin&&CWPDFReader.set_bLogin(!1),CWPDFReader.updateUser(CWDataCenter.isLogin),e&&e()},onFailure:function(a){b.loginChecked=!0;setTimeout(function(){b.loginChecked=!1},3E3);b.isWorking=!1;CWUtils.log("error");CWUtils.log("not logged in");b.isLogin=!1;CWPDFReaderConfig.pbxURL=null;CWPDFReader.updateUser(b.isLogin);e&&e();b.postMsgToSentry({message:"checklogin failed",
stack:a.responseText})}};CWApiHandler.checkLogin({url:d,success:function(a,b,e){return f.onSuccess(a,b,e)},error:function(a){return f.onFailure(a)}})}};c.prototype.correctMods=function(a){a.titleInfo&&"object"===typeof a.titleInfo.title&&a.titleInfo.title.__text&&(a.titleInfo.title=a.titleInfo.title.__text,delete a.titleInfo.title.__text);if(a.name)for(var e=0;e<a.name.length;e++){var b=a.name[e];if(b._type){b.type=b._type;delete b._type;for(var d=0;d<b.namePart.length;d++)b.namePart[d]._type&&(b.namePart[d].type=
b.namePart[d]._type,delete b.namePart[d]._type)}}if(a.relatedItem&&a.relatedItem._type&&(a.relatedItem.type=a.relatedItem._type,delete a.relatedItem._type,a.relatedItem.part&&a.relatedItem.part.detail))for(e=0;e<a.relatedItem.part.detail.length;e++)b=a.relatedItem.part.detail[e],b._type&&(b.type=b._type,delete b._type);a.titleInfo&&a.titleInfo.title&&(a.titleInfo.title=a.titleInfo.title.replace(/<\/?italic>/g,""))};c.prototype.getCSLFile=function(a,e){var b=this;CWUtils.ajax.get(a,{},function(a){e?
CwZ.ajax({url:CWPDFReaderConfig.cwURL+"/cites?ret=a&doi="+e,data:{},success:function(e,c,g){try{var l=(new X2JS({attributePrefix:new String("")})).xml2json(e);b.correctMods(l.Entity.mods);var n=new MODSParser(null,l.Entity.mods),n=JSON.stringify(n);CWPDFReader.cslResponse(a,n)}catch(m){CWPDFReader.cslResponse(a)}},error:function(){console.log("error")}}):CWPDFReader.cslResponse(a)})};c.prototype.getCSLJson=function(a){CWUtils.ajax.get(a,{},function(a){CWPDFReader.cslJSONResponse(a)})};c.prototype.loadConfig=
function(a,e){try{var b=this;b instanceof window.constructor&&(b=CWDataCenter);if(!b.isWorking){b.isWorking=!0;var d=(new Date).getTime(),f={onSuccess:function(f){b.isWorking=!1;var d={};try{d=CwZ.parseJSON(f);CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher&&CWPDFReader.sendJSONToReader(d);b.proId=d.proId;b.token=d.token;b.userEmail=d.email;var c=CWPDFReaderConfig.cwURL+CWUtils.generateEntLinks(b.proId,d.uName,"101",!1);b.myProfileLink=c;f=CWPDFReaderConfig;if(0>=d.uId.length)return;CWPDFReaderConfig=
d;CWPDFReaderConfig.uId=d.uId;CWPDFReaderConfig.debug=f.debug;CWPDFReaderConfig.pubModeBtnsTxt=f.pubModeBtnsTxt;CWPDFReaderConfig.extModeBtnsTxt=f.extModeBtnsTxt;CWPDFReaderConfig.readerMode=f.readerMode;CWPDFReaderConfig.cwURL=f.cwURL;CWPDFReaderConfig.parser=f.parser;CWPDFReaderConfig.domain=f.domain;CWPDFReaderConfig.staticDomainURL=f.staticDomainURL;CWPDFReaderConfig.sentryDomain=f.sentryDomain;CWPDFReaderConfig.piwikSiteId=f.piwikSiteId;CWPDFReaderConfig.isCoreMode=f.isCoreMode;CWPDFReaderConfig.isDesktopMode=
f.isDesktopMode;CWPDFReaderConfig.checkReaderMode=f.checkReaderMode;CWPDFReaderConfig.setPublisher=f.setPublisher;CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?CWPDFReaderConfig.checkReaderMode("drive")&&b.loadContacts():(CWPDFReader.updateUser(b.isLogin),("undefined"==typeof e||e)&&CWPDFReaderConfig.readerMode!=CWPDFReaderMode.Publisher&&b.findPubs());a&&a()}catch(g){b.isLogin=!1,b.exceptionHandler(g)}if(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox"))d=
"<div id='cw-pdfReaderConfig' style='display:none;'>"+JSON.stringify(CWPDFReaderConfig)+"</div>",CwZ("#cw-pdfReaderConfig").length?CwZ("#cw-pdfReadeConfig").replaceWith(d):CwZ("body").append(d);else if(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode())try{CWPDFReader.loadFile()}catch(h){}CWUtils.log("CWDataCenter.loadConfig DATA LOADED")},onFailure:function(a){b.ajaxError();b.postMsgToSentry({message:"loadConfig failed",stack:a.responseText})}},c={url:CWPDFReaderConfig.isDesktopMode()?
"app/data/extension.json":CWPDFReaderConfig.cwURL+"/app?x=/pub/extension.json&ts="+d,data:{},success:function(a){return f.onSuccess(a)},error:function(a){return f.onFailure(a)}};CWApiHandler.loadConfig(c)}}catch(g){this.exceptionHandler(g)}};c.prototype.loadContacts=function(){var a=this,e={onSuccess:function(b,f,e){CWUtils.log(b);a.etArray["101"]=b;CWUtils.log(f);a.loadGroups()},onFailure:function(b){a.postMsgToSentry({message:"load contacts failed",stack:b.responseText})}},b={url:CWPDFReaderConfig.cwURL+
"/app?x=/search/autocomplete.json&et=101",success:function(a,b,c){return e.onSuccess(a,b,c)},error:function(a){return e.onFailure(a)}};CwZ.isEmptyObject(a.etArray)&&CWApiHandler.loadContacts(b)};c.prototype.loadGroups=function(){var a=this,e={onSuccess:function(b,e,f){CWUtils.log(b);a.etArray["161"]=b;a.etArray.proId=a.proId;CWUtils.log(a.etArray);try{CWPDFReader.driveSetUaC(a.etArray)}catch(c){}},onFailure:function(b){a.postMsgToSentry({message:"load groups failed",stack:b.responseText})}};CWApiHandler.loadGroups({url:CWPDFReaderConfig.cwURL+
"/app?x=/search/autocomplete.json&et=161",success:function(a,d,f){return e.onSuccess(a,d,f)},error:function(a){return e.onFailure(a)}})};c.prototype.syncData=function(){var a=this;try{(CWPDFReaderConfig.isDesktopMode()||null!=a.fileId)&&a.checkLogin(function(){a.loadComments(function(b,e){if(CWPDFReaderConfig.checkReaderMode("library")||CWPDFReaderConfig.checkReaderMode("librarydesktop"))if(b)CWCommentManager.loadComments(b);else{var f=CWCommentManager.getCommentsString();a.saveComments(f)}else CWPDFReaderConfig.checkReaderMode("drive")?
CWCommentManager.loadComments(b,e):CWPDFReader.loadComments(b);setTimeout(function(b){return a.saveComments()},1E3)},CWPDFReaderConfig.checkReaderMode("drive"))},function(){CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?CWPDFReaderDialog.show({msg:"You are logged out. Kindly sign in to colwiz and retry to continue. ",okBtnTxt:"Retry",cnclBtnTxt:"Close reader",onOk:function(){a.syncData()},onCancel:function(){CWPDFReader.hasPendingChanges(!1);open(location.toString(),"_self").close()}}):
(CWPDFReader.showLoginFrame(),CWPDFReader.hideSyncingDisplay())})}catch(e){a.exceptionHandler(e)}};c.prototype.loadComments=function(a,e){var b=this;CWPDFReaderConfig.isDesktopMode()&&(CWPDFReaderConfig.cmtURL="app/data/comments.json",CWPDFReaderConfig.cmtAllURL="app/data/commentsAll.json");b instanceof window.constructor&&(b=CWDataCenter);if("undefined"!=typeof CWPDFReaderConfig.cmtURL||"undefined"!=typeof CWPDFReaderConfig.cmtAllURL){var d={onSuccess:function(f){try{if(-1!==f.indexOf("failure"))b.isLogin=
!1,CWPDFReaderConfig.dataImgURL="",CWPDFReader.updateUser(),1==confirm("Your session seems to be expired, please reload.")?CWPDFReaderConfig.readerMode===CWPDFReaderMode.Publisher&&CWPDFReader.reloadPage():CWPDFReader.logoutFromReaderCallback();else{var e=CwZ.parseJSON(f);f=null;var d=!1,c=0,n=0,m=null,p=!1,u=null,q=function(){if(!b.comments[CWPDFReaderConfig.uId]){var a=CWCommentManager.getDummyData().Colwiz.Comment[0];a.ownerId=u;a.isDummy=!0;b.comments[CWPDFReaderConfig.uId]=a}},t=function(a){r=
CwZ.parseJSON(a);v=r.List.MemberData[0].data.Graphics.length;w=r.List.MemberData[0].data.Comments.length;return v+w};if(e.Colwiz&&e.Colwiz.Comment){if(CWPDFReaderConfig.checkReaderMode("library")||CWPDFReaderConfig.checkReaderMode("librarydesktop"))f=e.Colwiz.Comment[0],f.isCurrentUser=!0,f.commentsString=CWUtils.decompress(f.settings);else if(CWPDFReaderConfig.checkReaderMode("drive")){for(var r,v,w,x=0;x<e.Colwiz.Comment.length;x++){var k=e.Colwiz.Comment[x];k.commentsString=CWUtils.decompress(k.settings);
b.comments||(b.comments={});b.comments[k.uId]=k;k.isDummy=!1;!m&&k.uId!==k.ownerId&&k.uId!=CWPDFReaderConfig.uId&&0<t(k.commentsString)&&(m=k.uId);k.uId===k.ownerId&&(p=k.isOwner=!0,u=k.uId,n=t(k.commentsString),f||(f=k));k.uId===CWPDFReaderConfig.uId&&(d=!0,c=t(k.commentsString),k.isCurrentUser=!0,k.uName="My Annotations",f=k)}d?f=d&&0!==c?b.comments[CWPDFReaderConfig.uId]:p&&0!==n?b.comments[u]:m?b.comments[m]:b.comments[Object.keys(b.comments)[0]]:q();f||(y=b.comments[CWPDFReaderConfig.uId])&&
(f=y)}else f=e.Colwiz.Comment[0],f.commentsString=CWUtils.decompress(f.settings),f=f.commentsString;f&&f.isCurrentUser&&f.mts&&(b.tsCmt=parseInt(f.mts))}else if(CWPDFReaderConfig.checkReaderMode("drive")){q();var y;for(x in b.comments)if(b.comments.hasOwnProperty(x)){k=b.comments[x];k.isDummy&&(y=k);!f&&0<t(k.commentsString)&&(f=k);break}f||(f=y)}else e.Colwiz.Comment&&(f=e.Colwiz.Comment[0],f.commentsString=CWUtils.decompress(f.settings),f=f.commentsString);a&&a(f,b.comments)}}catch(z){-1!=z.message.indexOf("Unexpected token <")&&
(b.isLogin=!1,CWPDFReaderConfig.dataImgURL="",CWPDFReader.updateUser(),CWPDFReader.showLoginFrame()),CWPDFReaderConfig.checkReaderMode("publisher")?PDFRaven.captureException(z):CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?PDFRaven.captureException(z.stack):PDFRaven.checkDomain()&&CWComManager.postExcToSentry(z),CWUtils.log("loadComments: Comments not Found"),a&&a("")}},onFailure:function(){b.postMsgToSentry({message:"load comments failed",stack:""});b.ajaxError()}};CWApiHandler.loadComments({url:e?
CWPDFReaderConfig.cmtAllURL:CWPDFReaderConfig.cmtURL,data:{eId:b.fileId,uId:CWPDFReaderConfig.uId,svc:"cl"},success:function(a){return d.onSuccess(a)},error:function(){return d.onFailure()}})}};c.prototype.saveComments=function(a){var e=this;if(CWPDFReaderConfig.readerMode!=CWPDFReaderMode.OpenDrive||cPDF.allowMe())try{if(CWPDFReaderConfig.readerMode==CWPDFReaderMode.LibraryDesktop&&(e.fileId={}),e.fileId){if("undefined"===typeof a||""===a||!a)if(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode())a=
CWCommentManager.getCommentsString();else{CWPDFReader.getComments();return}if(a){var b;try{0<(a.match(/\n/g)||[]).length&&(a=a.split("\n").join("!^!")),b=CwZ.parseJSON(a)}catch(d){var f=d.message,c;0<f.indexOf("Unexpected token")&&(c=f.split("token ")[1]);a=a.replace(c,"");b=CwZ.parseJSON(a)}var g=!1;b&&(0<b.List.MemberData[0].data.Comments.length||0<b.List.MemberData[0].data.Graphics.length)&&(g=!0);b={};b.id=e.fileId;b.os="16";0<e.tsCmt&&(b.mts=e.tsCmt);b.eus=CWUtils.compress(a);CWPDFReaderConfig.isDesktopMode()&&
(b={Colwiz:{Comment:[{settings:CWUtils.compress(a),mts:e.tsCmt}]}});g&&(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||e.sendOnce||(e.sendOnce=!0));if(e.lastSyncTS!=b.mts||"undefined"==typeof b.mts){var l=CWPDFReaderConfig.isDesktopMode()?"app/data/comments.json":CWPDFReaderConfig.pbxURL,n={onSuccess:function(a){a=CwZ.parseJSON(a);a.success?(CWUtils.log("saveComments response:"+a),g&&CWPDFReader.showProgress("sync-progress","Comments have synced successfully.",0)):CWPDFReaderConfig.isCoreMode()||
CWPDFReaderConfig.isDesktopMode()?(a={msg:"Comments not synced. Please try again or reload the page.",okBtnTxt:"Retry",cnclBtnTxt:"Close reader",onOk:function(){e.syncData()}},CWPDFReaderConfig.isCoreMode()&&CWPDFReaderDialog.show(a)):CWPDFReader.logConsole("Comments not synced. Please try again or reload the page.","Sync failed",!0);CWPDFReader.hideProgress(1500)},onFailure:function(a){e.postMsgToSentry({message:"save comments failed",stack:""});e.ajaxError(a)}};CWApiHandler.saveComments({url:l,
data:b,success:function(a){return n.onSuccess(a)},error:function(a){return n.onFailure(a)}})}else CWUtils.log("same mts, save comments successfull"),g&&CWPDFReader.showProgress("sync-progress","Comments have synced successfully.",0);e.lastSyncTS=b.mts}else CWPDFReader.hideProgress(1)}}catch(m){e.exceptionHandler(m)}else CWPDFReader.hideProgress(100)};c.prototype.addToLibrary=function(a,e){function b(){try{if("109"==parseInt(CWPDFReader.currentPubEId,16).toString().slice(0,3))void 0!=CWPDFReaderConfig.uId?
d.addToLibraryThroughPBX():(d.isWorking=!1,d.loadConfig(d.addToLibraryThroughPBX));else if(null==CWTaskManager.curTask||null!=CWTaskManager.curTask&&a!=CWTaskManager.curTask.data.index){var b=a;void 0==a&&d.pubSelected?b=d.pubSelected:CWPDFReader.pageData&&0<CWPDFReader.pageData.length&&-1==a?b=CWPDFReader.pageData[0]:d.pubs[a]&&(b=d.pubs[a]);if(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox"))try{CWPDFReader.pubsOnOtherSitesArr[a].addOtherPubs?(b=CWPDFReader.pubsOnOtherSitesArr[a],
CWPDFReader.addOtherPub=!1):CWPDFReader.pubsOnOtherSitesArr[a].addOtherPdfs&&(b=CWPDFReader.pdfsOnOtherSitesArr[a],CWPDFReader.addOtherPdf=!1)}catch(e){}var c=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/;c.test(b.title)||(b.title=Base64.encode(b.title));try{if(void 0!=a&&""!=a&&!d.pubs[a]&&(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox")))for(var l=0;l<CWPDFReader.records.length;l++)CWPDFReader.records[l].index==
a&&(b=CWPDFReader.records[l],c.test(b.title)||(b.title=Base64.encode(b.title)))}catch(n){}if(null!=b&&void 0!=b){var m=new CWTask;m.data=b;m.state=CWTaskState.FindPub;m.bAddToLib=!0;CWTaskManager.addTask(m)}}}catch(p){d.exceptionHandler(p)}}var d=this;e?b():d.checkLogin(function(){b()},function(){CWPDFReader.showLoginFrame(b);if("109"==parseInt(CWPDFReader.currentPubEId,16).toString().slice(0,3)){var a=CwZ(CwZ("#cw-loginFrame")[0].contentWindow.document.body).find(".cw-login-form #returnURL");a.attr("value",
a.attr("value").replace("&success=2","&success=3"))}})};c.prototype.addToLibraryThroughPBX=function(){var a=this;a.findPubForPublicPage(function(){CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:CWPDFReader.currentPubEId,os:5},function(e){a.findFileForPublicPagePDF(JSON.parse(e).success)})})};c.prototype.findPubForPublicPage=function(a){var e=this;e instanceof window.constructor&&(e=CWDataCenter);try{CWUtils.ajax.get(CWPDFReaderConfig.cwURL+"/app?x=451&et=109&rsvp=1&eId="+
CWPDFReader.currentPubEId,{},function(b,f,c){b=CwZ.parseXML(b);CwZ(b).find("Colwiz Euser settings").length?(e.pubSelected={id:CWPDFReader.currentPubEId,pdfLink:CWPDFReader.currentPubPdfLink},CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:CWPDFReader.currentPubEId,os:5},function(a){e.findFileForPublicPagePDF(JSON.parse(a).success)}),CWComManager.tell("hasPubInLib",{fileInLib:!0,view:"pdfFrame"})):void 0!=a&&a()})}catch(b){console.log(b)}};c.prototype.findFileForPublicPagePDF=
function(a){var e=this,b={},d={},f={};b.euId=a.euId;b.create=1;b.fileTitle=CWPDFReader.currentPubPdfLink;CWUtils.ajax.post(CWPDFReaderConfig.cwURL+"/pub/findfile",b,function(b){var c=null;try{c=CwZ.parseJSON(b)}catch(l){return}200==c.sc?(d.fileId=c.fileId,e.fileId=c.fileId,CWPDFReader.hasPubInLib(!0,d.index),f.state=CWTaskState.Finished,f.bInProcess=!1,CWTaskManager.curTask=f,e.pubSelected=d,CWTaskManager.process(),f.bAddToLib||e.syncData()):201==c.sc?(f.data={},f.data.euId=a.euId,f.data.fileId=c.fileId,
f.data.pdfLink=CWPDFReader.currentPubPdfLink,f.data.blobLink=CWPDFReader.currentPubPdfLink,d.fileId=c.fileId,e.fileId=c.fileId,f.state=CWTaskState.UploadFile,f.bInProcess=!1,CWTaskManager.curTask=f,e.pubSelected=d,CWTaskManager.process()):e.failuresHandler({type:"findfile",e:Error("find file error"),objTask:f})},e.ajaxError)};c.prototype.downloadCitations=function(a){var e=this,b=a.data,d=a.type;CWPDFReader.exportCitIdx=0;var f=function(){var a=b[CWPDFReader.exportCitIdx],a=parseInt(a),c=-1==a?CWPDFReader.pageData[0]:
CWPDFReader.records[a];CWParser.name&&CWParser.isPubPage()&&(c=CWPDFReader.records[0]);var l=c.type==d;if("webpage"==c.redif_type&&0==CWPDFReader.records.length){if("bib"==c.type||"ris"==c.type)/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/.test(c.data)&&(c.data=Base64.decode(c.data)),a=c.data,l||(a=citConverterMain(a,d,c)),CWPDFReader.exportCit[d].push(a);++CWPDFReader.exportCitIdx==b.length?(e.saveAndReset(),setTimeout(function(){CWPDFReader.processingDownloadCit=
!1;CWPDFReader.exportInProgress=!0},2E3)):f()}else Utility.getData({metadata:c,success:function(a,h){c.data=a;c.type=h;if("bib"==c.type||"ris"==c.type){/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/.test(c.data)&&(c.data=Base64.decode(c.data));var p=c.data;l||(p=citConverterMain(p,d,c));CWPDFReader.exportCit[d].push(p);++CWPDFReader.exportCitIdx==b.length?(e.saveAndReset(),setTimeout(function(){CWPDFReader.processingDownloadCit=!1;CWPDFReader.exportInProgress=
!0},2E3)):f()}else e.saveAndReset(),setTimeout(function(){CWPDFReader.processingDownloadCit=!1;CWPDFReader.exportInProgress=!0;CWlogger.logConsole("Extension doesn't support '"+c.type+"' publication type for export citation.","Publication type not supported!",!0)},1E3)},error:function(){CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&(CWComManager.exportedCitation=[])}})};f()};c.prototype.saveAndReset=function(){var a=["bib","ris"];CwZ(a).each(function(e){e=a[e];var b=CWPDFReader.exportCit[e];
if(b.length){var b=b.join("\n\n"),c=new Blob([b],{type:"text/plain;charset=utf-8"});CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&(CWComManager.exportedCitation=b);saveAs(c,"ExportCitation."+e)}});CWPDFReader.exportCit={bib:[],ris:[]}};c.prototype.downloadPDF=function(a){saveAs(a.blob,a.name)};c.prototype.getFileId=function(a){var e=this.pubSelected;if(null!=e){var b=new CWTask;b.data=e;b.state=CWTaskState.FindPub;b.bAddToLib=!1;a&&(b.bAddToLib=!0);CWTaskManager.checkedLogin=!0;CWTaskManager.addTask(b)}};
c.prototype.getPostData=function(a,e){void 0==e&&(e=!1);try{var b={authors:a.authors?a.authors:"",dataUrl:a.dataUrl?a.dataUrl:"",identifier:a.identifier?a.identifier:"",identifierType:a.identifierType?a.identifierType:"",index:0,psp:0,pdfLink:a.pdfLink?a.pdfLink:"",pubLink:a.pubLink?a.pubLink:"",title:a.title?a.title:"",type:a.type?a.type:"",domain:"webpdf",ts:(new Date).getTime()};void 0!=a.journal&&(b.journal=a.journal);void 0!=a.year&&(b.year=a.year);void 0!=a.openaccess&&(b.openaccess=a.openaccess);
void 0!=a.listingPage&&(b.listingPage=a.listingPage);void 0!=a.title&&(b.title=a.title);void 0!=a.authors&&(b.authors=a.authors);void 0!=a.issn&&(b.issn=a.issn);e&&(b.data=a.data);this.publisherOptions&&(b.appId=this.publisherOptions.appId,"0000-0000"!=this.publisherOptions.issn&&(b.issn=this.publisherOptions.issn));return b}catch(c){this.exceptionHandler(c)}};c.prototype.failuresHandler=function(a){var e=this,b={logout:{heading:"Logged out",msg:"You are logged out. Kindly sign in to colwiz and retry to continue. ",
buttons:{ok:"Retry",cancel:"Abort"},func:function(a){b.finishTask(a)}},createPubLimit:{heading:"Adding Publication Failed",msg:"Publication limit reached. Please contact support@colwiz.com. ",func:function(a){b.finishTask(a)}},createPub:{heading:"Adding Publication Failed",msg:"An error occurred while creating publication. Please retry after a few seconds. ",func:function(a){b.finishTask(a)}},addingPDF:{heading:"Adding PDF Failed",msg:"An error occurred while adding PDF . The publication has been added in your library though. Please retry after a few seconds. ",
func:function(a){b.finishTask(a)}},finishTask:function(a){var b=null;if(a.objTask)b=a.objTask;else if(a.index){a=a.index;var c=CWTaskManager.curTask,d=CWTaskManager.arrTasks;if(c&&c.data.index==a)b=c;else if(0<d.length)for(c=0;c<d.length;c++){var n=d[c];n.data.index==a&&(b=n)}}b&&(a=b.data,e.isLogin=!1,CWPDFReader.showProgress("userLoggedOut","User Logged Out",0,a.index),CWPDFReaderConfig.dataImgURL="",CWPDFReader.updateUser(),b.bInProcess=!1,b.state=CWTaskState.Finished,CWTaskManager.process())}},
c;switch(a.type){case "logout":c=b.logout;break;case "createpub":c=b.createPub;break;case "createpublimit":c=b.createPubLimit;break;case "addingPDF":c=b.addingPDF;break;case "uploadfile":c=b.addingPDF}(function(a,b){try{CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?CWPDFReaderDialog.show({msg:a.msg?a.msg:b.msg,okBtnTxt:a.okBtnTxt?a.okBtnTxt:b.buttons.ok,cnclBtnTxt:a.cnclBtnTxt?a.cnclBtnTxt:b.buttons.cancel,onOk:a.succFunc?a.succFunc:void 0,onCancel:a.errFunc?a.errFunc:void 0}):
CWPDFReader.logConsole(b.msg,b.heading,!0),b.func&&b.func(a)}catch(c){}})(a,c)};c.prototype.exceptionHandler=function(a){CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()?PDFRaven.captureException(a.stack):CWPDFReaderConfig.checkReaderMode("publisher")?PDFRaven.captureException(a):PDFRaven.checkDomain()&&CWComManager.postExcToSentry(a)};c.prototype.findPublication=function(a){function c(e){var f=b.getPostData(e);f.idType=e.identifierType;f.id=e.identifier;f.url=e.pubLink;var h={onSuccess:function(c){var f=
null;try{f=CwZ.parseJSON(c)}catch(h){b.failuresHandler({type:"logout",e:h,objTask:a});return}200==f.sc?(e.eId=f.eId,CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||CWPDFReader.setPublicationId(e.eId),f.euId?(e.euId=f.euId,a.state=CWTaskState.FindFile):a.state=a.bAddToLib?CWTaskState.CreatePub:CWTaskState.Finished):404==f.sc&&(a.bAddToLib?a.state=CWTaskState.CreatePub:(CWPDFReader.hideProgress(1),a.state=CWTaskState.Finished));a.bInProcess=!1;CWTaskManager.process()},onFailure:function(a){b.ajaxError(a);
b.postMsgToSentry({message:"findPub failed",stack:a.responseText})}};CWApiHandler.findPublication({url:CWPDFReaderConfig.cwURL+"/pub/findpub",data:f,success:function(a){return h.onSuccess(a)},error:function(a){return h.onFailure(a)}})}var b=this;b.checkLogin(function(){a.bAddToLib&&CWPDFReader.showProgress("addPub","Adding...",0,a.data.index);var d=a.data;if(d)try{c(d)}catch(f){b.exceptionHandler(f)}},function(){})};c.prototype.createPublication=function(a){var c=this;try{var b=a.data,d=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$/;
if(b&&0!=b.data.length){d.test(b.data)||(b.data=Base64.encode(b.data));d.test(b.title)||(b.title=Base64.encode(b.title));var f=c.getPostData(b,!0);null!=b.eId&&(f.eId=b.eId);var h="["+JSON.stringify(f)+"]";f.data=h;var g={onSuccess:function(d){try{c.postToTracker("createPublication",b)}catch(f){}if(""==d)c.failuresHandler({type:"logout",e:g,objTask:a});else{g=null;try{g=CwZ.parseJSON(d)}catch(h){c.failuresHandler({type:"logout",e:h,objTask:a});return}b.title=Base64.decode(b.title);if(200==g.sc)b.euId=
g.euId,b.eId||(b.eId=g.eId),CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode()||CWPDFReader.setPublicationId(b.eId),CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&CWComManager.addedEids.push(g.eId),a.state=CWTaskState.FindFile,CWPDFReader.showProgress("addPub","Adding...",50,a.data.index),a.bInProcess=!1,CWTaskManager.process();else if(501==g.sc){var g=Error("Publication Limit Reached");c.failuresHandler({type:"createpublimit",e:g,objTask:a})}else g=Error("create pub error"),
c.failuresHandler({type:"createpub",e:g,objTask:a})}},onFailure:function(a){CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&CWComManager.addedEids.push("failed");c.ajaxError(a);c.postMsgToSentry({message:"createPub failed",stack:a.responseText})}};CWApiHandler.createPublication({url:CWPDFReaderConfig.cwURL+"/pub/createpub",data:f,success:function(a){return g.onSuccess(a)},error:function(a){return g.onFailure(a)}})}else a.bInProcess=!1,(CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox"))&&
CWParser?(d.test(b.title)&&(b.title=Base64.decode(b.title)),CWParser.getData({metadata:b,success:function(a,d){b.data=a;b.data=Base64.encode(b.data);b.type=d;c.setMetaData(b,b.index)}})):(CWPDFReaderConfig.checkReaderMode("publisher")||CWPDFReaderConfig.readerMode===CWPDFReaderMode.Webimporter)&&CWPDFReader.getMetaData(b)}catch(l){c.exceptionHandler(l)}};c.prototype.findFile=function(a,c){var b=this;try{var d=a.data,f=CWUtils.getFileTitle(d),h=b.getPostData(d);if(1==a.bAddToLib){h.create=1;if(void 0==
c&&d.pdfLink&&""!=d.pdfLink){CWPDFReaderConfig.checkReaderMode("chrome")||CWPDFReaderConfig.checkReaderMode("firefox")?CWPDFReader.checkForPDFAccess(d.blobType):CWPDFReader.checkForPDFAccess(d.pdfLink);return}if(c)h.create=1;else{CWPDFReader.hasPubInLib(!0,d.index);a.state=CWTaskState.Finished;a.bInProcess=!1;CWTaskManager.process();return}}h.euId=d.euId;h.fileTitle=f;h.ts=(new Date).getTime();b.publisherOptions&&(h.appId=b.publisherOptions.appId,h.issn="0000-0000"!=b.publisherOptions.issn?b.publisherOptions.issn:
void 0!=d.issn?d.issn:"");void 0!=d.journal&&(h.journal=d.journal);void 0!=d.year&&(h.year=d.year);void 0!=d.openaccess&&(h.openaccess=d.openaccess);void 0!=d.listingPage&&(h.listingPage=d.listingPage);var g={onSuccess:function(c){var e=null;try{e=CwZ.parseJSON(c)}catch(f){b.failuresHandler({type:"logout",e:f,objTask:a});return}200==e.sc?(d.fileId=e.fileId,b.fileId=e.fileId,CWPDFReader.hasPubInLib(!0,d.index),a.state=CWTaskState.Finished,a.bInProcess=!1,CWTaskManager.process(),b.syncData()):201==
e.sc?(d.fileId=e.fileId,b.fileId=e.fileId,a.state=CWTaskState.UploadFile,a.bInProcess=!1,CWTaskManager.process()):(b.fileId=e.fileId,CWPDFReader.hasPubInLib(!0,d.index),a.state=CWTaskState.Finished,a.bInProcess=!1,CWTaskManager.process(),b.failuresHandler({type:"findfile",e:Error("find file error"),objTask:a}))},onFailure:function(a){b.ajaxError(a);b.postMsgToSentry({message:"findFile failed",stack:a.responseText})}};CWApiHandler.findFile({url:CWPDFReaderConfig.cwURL+"/pub/findfile",data:h,success:function(a){return g.onSuccess(a)},
error:function(a){return g.onFailure(a)}})}catch(l){b.exceptionHandler(l)}};c.prototype.uploadFile=function(a){try{var c={euId:a.data.euId,fileId:a.data.fileId};CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher||CWPDFReaderConfig.readerMode==CWPDFReaderMode.Webimporter?CWPDFReader.uploadFile(a.data.pdfLink,a.data.index,c):CWPDFReader.uploadFile(a.data.blobLink,a.data.index,c)}catch(b){this.exceptionHandler(b)}};c.prototype.getUploadParams=function(a){var c=this;CWUtils.log(CWPDFReaderConfig.cwcURL);
try{var b={onSuccess:function(b){var d,g={};if(b.success)d=b.success;else if(b.failure&&"logged out."==b.failure.msg){this.failuresHandler({type:"logout",e:Error("Logged out")});return}d&&(CWTaskManager.curTask.data.fileId=d.eId,g.key=d.key,g.acl=d.acl,g.AWSAccessKeyId=d.AWSAccessKeyId,g.policy=d.policy,g.signature=d.signature,g.Filename=a.title,c.setKeyValue("x-amz-server-side-encryption",d,g),c.setKeyValue("x-amz-meta-uuid",d,g),c.setKeyValue("x-amz-storage-class",d,g),c.setKeyValue("Content-Disposition",
d,g),c.setKeyValue("Content-Type",d,g),CWPDFReader.postFile(g,d.postURL))},onFailure:function(a){CWUtils.log("Either you don't have rights to post or your uploaded quota is finished. ");c.postMsgToSentry({message:"getUploadParams failed",stack:a.responseText})}};CWApiHandler.getUploadParams({url:CWPDFReaderConfig.cwcURL,data:a,success:function(a){return b.onSuccess(a)},error:function(a){return b.onFailure(a)}})}catch(d){c.exceptionHandler(d)}};c.prototype.setKeyValue=function(a,c,b){(c=c[a])&&(b[a]=
c)};c.prototype.uploadSync=function(a){var c=this;void 0===a.doSync&&(a.doSync=!1);try{var b={onSuccess:function(){CWUtils.log("UPLOAD SYNC:"+a.sync);2==a.sync&&(CWPDFReader.hasPubInLib(!0,a.index),CWTaskManager.curTask.state=CWTaskState.Finished,CWTaskManager.curTask.bInProcess=!1,CWTaskManager.process(),a.doSync&&c.syncData())},onFailure:function(a){c.postMsgToSentry({message:"uploadSync failed",stack:a.responseText})}};CWApiHandler.uploadSync({url:CWPDFReaderConfig.cwcURL,data:a,success:function(){return b.onSuccess()},
error:function(a){return b.onFailure(a)}})}catch(d){c.exceptionHandler(d)}};c.prototype.getFileURL=function(a,c,b,d){try{var f=CWPDFReaderConfig.cwcURL.replace("&et=28","&et="+c);a={eId:a,geturl:1};b&&(a.preview=!0);CWApiHandler.getFileURL({url:f,data:a,success:d,error:this.ajaxError})}catch(h){this.exceptionHandler(h)}};c.prototype.polling=function(){this.loadConfig(function(){})};c.prototype.updateUserDOM=function(){CWPDFReader.updateUser()};c.prototype.postMsgToSentry=function(a){if(!CWUtils.sentry[a.message]){CWUtils.sentry[a.message]=
!0;CWUtils.log("in final sentry tracking func: "+a.message);var c=Error(a.message);c.stack=a.stack;CWUtils.log(c);try{PDFRaven.captureException(c)}catch(b){}}};c.prototype.setImporter=function(){this.isWebImporter=!0};c.prototype.postToTracker=function(a,c){try{var b,d=c||this.pubSelected;if(this.isWebImporter||CWPDFReaderConfig.checkReaderMode("chrome")&&null==d)d="undefined"!=typeof CWPDFReader.pageData&&0<CWPDFReader.pageData.length?CWPDFReader.pageData[0]:this.pubs[0];CWPDFReaderConfig.checkReaderMode("publisher")&&
null==d&&this.pubs&&(d=this.pubs[0]);if(null!=d){var f=[];if("events"===a){try{f=d.match(/"(.*?)"/g)}catch(h){}b={};b.events=d;this.pubSelected&&void 0!==this.pubSelected.issn&&(b.issn=this.pubSelected.issn);this.publisherOptions&&(b.appId=this.publisherOptions.appId);"undefined"===typeof b.appId&&(b.appId="undefined"!=typeof CWParser?"undefined"!=typeof CWParser.name?CWParser.name+"_extension":"webpageReference_extension":"webpageReference_extension")}else b=this.getPostData(d),"undefined"==typeof b.appId&&
(b.appId="undefined"!=typeof CWParser?"undefined"!=typeof CWParser.name?CWParser.name+"_extension":"webpageReference_extension":"webpageReference_extension"),b.idType=d.identifierType,b.id=d.identifier,b.url=d.pubLink,delete b.title,delete b.data,delete b.authors,delete b.dataUrl,delete b.identifierType,delete b.index,delete b.psp,delete b.pdfLink,delete b.pubLink,delete b.type,delete b.domain,delete b.idType,delete b.domain;b.lts=this.trackerStamp;b.tId=this.trackerID;this.trackerStamp=(new Date).getTime();
b.uId=CWPDFReaderConfig.uId||CWUtils.readCookie("_ut");if(!b.uId){var g=1E4*b.ts+(Math.floor(2E3*Math.random())+1E3);b.uId="u"+g.toString(16);CWPDFReaderConfig.checkReaderMode("chrome")&&(-1==CWPDFReader.postDataUId&&(CWPDFReader.postDataUId=b.uId),b.uId=CWPDFReader.postDataUId);CWUtils.writeCookie("_ut",b.uId,365)}"searchKeyword"==a.action?(b.action=a.action,b.searchQuery=a.key):b.action=a;if("https://www.colwiz.com"==CWPDFReaderConfig.cwURL||"https://qa.colwiz.com"==CWPDFReaderConfig.cwURL||"https://beta.colwiz.com"==
CWPDFReaderConfig.cwURL||"https://www.colwiz.com"==CWPDFReaderConfig.cwURL)switch(0==this.piwikConfigured&&(CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome?this.readerModePiwik="Chrome":CWPDFReaderConfig.readerMode==CWPDFReaderMode.Webimporter||this.isWebImporter?this.readerModePiwik="WebImporter":CWPDFReaderConfig.readerMode==CWPDFReaderMode.Publisher?this.readerModePiwik="Reader":CWPDFReaderConfig.readerMode==CWPDFReaderMode.Library?this.readerModePiwik="Library":CWPDFReaderConfig.readerMode==
CWPDFReaderMode.Drive&&(this.readerModePiwik="Drive"),this.piwikConfigured=!0,this.injectPiwik(b)),a){case "events":try{for(d=0;d<f.length;d++)f[d]=f[d].replace(RegExp('"',"g"),""),this.trackPiwik(f[d],b)}catch(l){}break;default:"undefined"!==typeof a.action?this.trackPiwik(a.action,b):this.trackPiwik(a,b)}}}catch(n){}};c.prototype.injectPiwik=function(a){var c=this;if(CWPDFReaderConfig.piwikSiteId)if(CWPDFReaderConfig.piwikSiteId="https://www.colwiz.com"==CWPDFReaderConfig.cwURL?2:5,CWPDFReaderConfig.readerMode==
CWPDFReaderMode.Chrome)try{if("undefined"!=typeof CwZ("#piwikFrame")[0])if(c.piwikFrameLoaded){CwZ("#piwikFrame")[0].contentWindow.postMessage({message:"appendPiwikjs"},"*");var b={message:"initPiwik",piwikSiteId:CWPDFReaderConfig.piwikSiteId};"undefined"!==typeof a&&(b.appId=a.appId,b.issn=null===a.issn?"notfound":a.issn,b.journal=null===a.journal?"notfound":a.journal);CwZ("#piwikFrame")[0].contentWindow.postMessage(b,"*")}else setTimeout(function(){c.injectPiwik()},1E3);else setTimeout(function(){c.injectPiwik()},
1E3)}catch(d){CWUtils.log(d)}else(function(){_paq.push(["setTrackerUrl","https://reports.colwiz.com/piwik/piwik.php"]);_paq.push(["setSiteId",CWPDFReaderConfig.piwikSiteId]);var a=document,b=a.createElement("script"),a=a.getElementsByTagName("script")[0];b.type="text/javascript";b.defer=!0;b.async=!0;b.src="https://reports.colwiz.com/piwik/piwik.js";a.parentNode.insertBefore(b,a)})(),_paq.push(["enableLinkTracking"]),_paq.push(["setCustomVariable",5,"ReaderMode",c.propName(CWPDFReaderMode,CWPDFReaderConfig.readerMode),
"visit"]),"undefined"!==typeof a&&(_paq.push(["setCustomVariable",4,"AppID",a.appId,"visit"]),_paq.push(["setCustomVariable",3,"ISSN",null===a.issn?"notfound":a.issn,"visit"]),_paq.push(["setCustomVariable",2,"Journal",null===a.journal?"notfound":a.journal,"visit"])),"undefined"!==typeof CWPDFReaderConfig.uId&&_paq.push(["setUserId",CWPDFReaderConfig.uId]),_paq.push(["trackPageView"])};c.prototype.trackPiwik=function(a,c){var b=this;if(CWPDFReaderConfig.piwikSiteId)if(CWPDFReaderConfig.readerMode==
CWPDFReaderMode.Chrome)try{"clickpdf"==a?setTimeout(function(){CwZ("#piwikFrame")[0].contentWindow.postMessage({message:"trackPiwik",action:a,readerModePiwik:b.readerModePiwik,piwikSiteId:CWPDFReaderConfig.piwikSiteId},"*")},1E3):CwZ("#piwikFrame")[0].contentWindow.postMessage({message:"trackPiwik",action:a,readerModePiwik:b.readerModePiwik,piwikSiteId:CWPDFReaderConfig.piwikSiteId},"*")}catch(d){}else _paq.push(["setCustomVariable",5,"ReaderMode",b.propName(CWPDFReaderMode,CWPDFReaderConfig.readerMode),
"visit"]),"undefined"!==typeof c&&(_paq.push(["setCustomVariable",4,"AppID",c.appId,"visit"]),_paq.push(["setCustomVariable",3,"ISSN",null===c.issn?"notfound":c.issn,"visit"]),_paq.push(["setCustomVariable",2,"Journal",null===c.journal?"notfound":c.journal,"visit"])),"undefined"!==typeof CWPDFReaderConfig.uId&&_paq.push(["setUserId",CWPDFReaderConfig.uId]),_paq.push(["trackEvent",b.readerModePiwik,a])};c.prototype.propName=function(a,c){for(var b in a)if(a[b]==c)return b;return c};c.prototype.findPubs=
function(){var a=this;if(CWPDFReaderConfig.readerMode!=CWPDFReaderMode.Webimporter){var c=[];if(a.pubs)for(var b in a.pubs){var d=a.pubs[b],d={type:d.identifierType,value:d.identifier,url:d.pubLink,pdfLink:d.pdfLink};c.push(d)}else for(b in CWPDFReader.pageData)d=CWPDFReader.pageData[b],d={type:d.identifierType,value:d.identifier,url:d.pubLink,pdfLink:d.pdfLink},c.push(d);c=JSON.stringify(c);b={};b.ids='{"ids":'+c+"}";try{var f={onSuccess:function(b,c,d){c=null;try{if(-1==(d.getResponseHeader("content-type")||
"").indexOf("html")&&-1==b.indexOf('{"failure":')&&(c=CwZ.parseJSON(b),CWPDFReaderConfig.readerMode==CWPDFReaderMode.Chrome&&(CWComManager.findPubs=c),CWUtils.log("findPubs response:  "+b),c.ids))for(b=0;b<c.ids.length;b++)if(c.ids[b].euId)CWPDFReader.hasPubInLib(!0,b);else if(!CWPDFReaderConfig.isCoreMode()&&!CWPDFReaderConfig.isDesktopMode()){var e=CwZ(".cw-btnContainer:eq("+b+") .cw-addToLib");e.hasClass("cw-vil")&&(e.removeClass("cw-vil"),e.removeClass("cw-ail"),e.removeClass("cw-qta"),e.addClass("cw-atl"),
e.find("span").html("Add to colwiz"),e.attr("data-tooltip","Save this article to your \r\n colwiz library to read \r\n and reference anywhere"))}}catch(f){CWUtils.log("FIND PUB ERROR"),a.exceptionHandler(f)}},onFailure:function(b){a.postMsgToSentry({message:"findPubs failed",stack:b.responseText})}};CWApiHandler.findPubs({url:CWPDFReaderConfig.cwURL+"/pub/findpubs",data:b,success:function(a,b,c){return f.onSuccess(a,b,c)},error:function(a){return f.onFailure(a)}})}catch(h){a.exceptionHandler(h)}}};
c.prototype.findPubsDOI=function(){var a=this;if(a.isLogin&&!a.bFindPubsChecked&&(!a.publisherOptions||a.publisherOptions.showAddToColwiz)){for(var c="",b=0;b<CWPDFReader.records.length;b++){var d=a.pubs[b];"doi"==d.identifierType&&(a.PubsDoiUrlHash[d.identifier]=b,c=""===c?c+("doi="+d.identifier):c+("&doi="+d.identifier))}try{CWUtils.ajax.get(CWPDFReaderConfig.cwURL+"/pub/findpubsbydoi?"+c,{},function(b){var c=null;try{for(c=CwZ.parseJSON(b).response,CWUtils.log("findpubsbydoi response:  "+b),b=
0;b<c.docs.length;b++){var d=c.docs[b];d.doi&&CWPDFReader.hasPubInLib(!0,a.PubsDoiUrlHash[d.doi])}}catch(e){a.exceptionHandler(e)}})}catch(f){a.exceptionHandler(f)}a.bFindPubsChecked=!0}};c.prototype.checkPendingTasks=function(){(null!=CWTaskManager.curTask||0<CWTaskManager.arrTasks.length)&&this.isLogin?CWPDFReader.setPendingTasks(!0):CWPDFReader.setPendingTasks(!1)};c.prototype.removeAllTasks=function(){CWTaskManager.removeAllTasks()};c.prototype.getRelatedPubs=function(a){try{CwZ.get(a).done(function(a){CWPDFReader.setRelatedPubs(a)})}catch(c){}};
c.prototype.getRefsFromServer=function(a,c){try{CwZ.get(a).done(function(a){CWPDFReader.serverRefsResponse(a,c)}).error(function(){CWPDFReader.serverRefsResponse(0,c)})}catch(b){}};c.prototype.addRelatedPub=function(a){var c=this;try{CWPDFReaderConfig.pbxURL?CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,{xTask:"update",uId:CWPDFReaderConfig.uId,id:a,os:5},function(b){CWPDFReader.addRelatedPubResp({eId:a,resp:b})}):c.isWorking?setTimeout(function(){c.addRelatedPub(a)},2E3):c.loadConfig(function(){CWUtils.ajax.post(CWPDFReaderConfig.pbxURL,
{xTask:"update",uId:CWPDFReaderConfig.uId,id:a,os:5},function(b){CWPDFReader.addRelatedPubResp({eId:a,resp:b})})})}catch(b){console.log(b)}};c.prototype.ajaxCall=function(a){try{CwZ.ajax({url:a.url,type:a.type,data:a.params,success:function(b){a.response=b;CWPDFReader.ajaxCallResp(a)},error:function(){CWPDFReader.ajaxCallResp(a)}})}catch(c){CWPDFReader.ajaxCallResp(a)}};c.prototype.getAuthors=function(a,c,b){b?(c=c.data.replace('["',"").replace('"]',""),a+=":"+encodeURIComponent(c),CwZ.ajax({type:"GET",
url:a,success:function(a,b,c){CWPDFReader.sendAuthors(a)},error:function(a){}})):CwZ.ajax({type:"POST",url:a,data:c,success:function(a,b,c){CWPDFReader.sendAuthors(a)},error:function(a){}})};c.prototype.getRelated=function(a,c,b,d,f){CwZ.get(a).done(function(a){CwZ.get(c).done(function(c){function e(a,b,c){a=CwZ(a);var d=a.find(".viewArticle").attr("href").replace("cw_pub=colwiz","colwiz-ref=ipdf-rec-pnl");CwZ(a.find("a")[0]).attr("href",d);CwZ(a.find("a")[0]).attr("target","_blank");CwZ(a.find(".listLinkContainer")).remove();
d=a.find(".year").text();c=c?"recommendationRelPubsClick":a.attr("source");CwZ(a.find("a")[0]).attr("source",c);d.match(/(18|19|20)\d{2}/g)&&a.find(".year").text(d.match(/(18|19|20)\d{2}/g)[0]);a.find(".title").text();c=a.find(".title").text();var f=a.find(".authors").text(),d=-1!==d.indexOf("1900-01-01")?a.find(".info .journal").length?'<span class="journal">'+a.find(".info .journal").html()+"</span>":"":a.find(".info").html();CwZ('<h3 class="title" title="'+c+'">'+c+"</h3>").insertAfter(a.find("span.title"));
CwZ('<p class="authors" title="'+f+'">'+f+"</p>").insertAfter(a.find("span.authors"));CwZ('<p class="info">'+d+"</p>").insertAfter(a.find("span.info"));CwZ(a).find("span.title").remove();CwZ(a).find("span.authors").remove();CwZ(a).find("span.info").remove();"cwList1"===b?p+="<li>"+a.html()+"</li>":u+="<li>"+a.html()+"</li>"}var n=CwZ(a),m=CwZ(c),p="",u="",q=[],t=[],r=0;if(b){c=function(a){for(var b=!1,c=!1,e=!1,g=a,h=a,l=a,p=function(){if(d[g]){var a=d[g];-1===t.indexOf(a)?(CwZ(n).each(function(c){if(CwZ(this).attr("id")==
a){var d=CwZ(this),e=!0;CwZ(q).each(function(){var a=CwZ(this).find(".title").text();if(d.find(".title").text()===a){var a=CwZ(this).find(".authors").text(),b=d.find(".authors").text();a===b&&(e=!1)}});e&&(CwZ(this).attr("source","recommendationTopClick"),q.push(CwZ(this)),t.push(a),r++,b=!0)}}),0==b&&g++):g++}};0==b&&g<d.length&&8>=r;)p();for(p=function(){if(f[h]){var a=f[h];-1===t.indexOf(a)?(CwZ(n).each(function(b){if(CwZ(this).attr("id")==a){var d=CwZ(this),e=!0;CwZ(q).each(function(){var a=CwZ(this).find(".title").text();
if(d.find(".title").text()===a){var a=CwZ(this).find(".authors").text(),b=d.find(".authors").text();a===b&&(e=!1)}});e&&(CwZ(this).attr("source","recommendationMLClick"),q.push(CwZ(this)),t.push(a),r++,c=!0)}}),0==c&&h++):h++}};0==c&&h<f.length&&8>=r;)p();for(p=function(){if(m[l])if(v=CwZ(m[l]).attr("id"),"undefined"!==typeof v&&-1===t.indexOf(v)){var b=m[l],c=!0;CwZ(q).each(function(){var a=CwZ(this).find(".title").text();if(CwZ(b).find(".title").text()===a){var a=CwZ(this).find(".authors").text(),
d=CwZ(b).find(".authors").text();a===d&&(c=!1)}});c&&(CwZ(m[a]).attr("source","recommendationRelPubsClick"),q.push(m[l]),t.push(v),r++,e=!0)}else l++};0==e&&l<m.length&&8>=r;)p()};for(var v,w=0;8>w&&8>=r;w++)c(w);0!=q.length&&(n=q.slice(0,4),m=q.slice(4,8),CwZ(n).each(function(){e(this,"cwList1")}),CwZ(m).each(function(a){e(this,"cwList2")}),CWPDFReader.setRelPubsOnPage(p,u))}else-1===a.indexOf("no-result-cw")&&-1===c.indexOf("no-result-cw")&&(n.each(function(){e(this,"cwList1","recommendationRelPubsClick")}),
m.each(function(){e(this,"cwList2","recommendationRelPubsClick")}),CWPDFReader.setRelPubsOnPage(p,u))})})};return c}(),CWDataCenter=new CWData_Center,PDFRaven={domain:CWPDFReaderConfig.cwURL,captureException:function(c){},captureMessage:function(c){},set:function(){Raven.TraceKit.domain=PDFRaven.domain;Raven.TraceKit.checkDomain=PDFRaven.checkDomain;PDFRaven=Raven.TraceKit},checkDomain:function(){return-1!=PDFRaven.domain.indexOf(CWPDFReaderConfig.sentryDomain)}};
(CWPDFReaderConfig.isCoreMode()||CWPDFReaderConfig.isDesktopMode())&&CWDataCenter.checkLogin(CWDataCenter.loadConfig);-1!=CWPDFReaderConfig.cwURL.indexOf(CWPDFReaderConfig.sentryDomain)&&(CWUtils.log("PDFRaven is set for this reader"),PDFRaven.set());
var CWTaskManager={arrTasks:[],curTask:null,checkedLogin:!1,addTask:function(c){try{0<CWTaskManager.arrTasks.length&&c.bAddToLib&&CWPDFReader.showProgress("queue","Queued to Add",0,c.data.index),CWTaskManager.arrTasks.push(c),CWTaskManager.process()}catch(a){CWDataCenter.exceptionHandler(a)}},removeTask:function(c){for(var a=0;a<CWTaskManager.arrTasks.length;a++)if(CWTaskManager.arrTasks[a].id==c)return CWTaskManager.arrTasks.splice(a,1)},removeAllTasks:function(){CWTaskManager.arrTasks=[];CWTaskManager.curTask=
null;CWTaskManager.checkedLogin=!1},process:function(){try{if(0<CWTaskManager.arrTasks.length&&null==CWTaskManager.curTask&&(CWTaskManager.curTask=CWTaskManager.arrTasks.shift()),CWTaskManager.curTask&&!CWTaskManager.curTask.bInProcess){var c=CWTaskManager.curTask;c.bInProcess=!0;switch(c.state){case CWTaskState.FindPub:CWDataCenter.findPublication(c);break;case CWTaskState.CreatePub:CWDataCenter.createPublication(c);break;case CWTaskState.FindFile:CWDataCenter.findFile(c);break;case CWTaskState.UploadFile:CWDataCenter.uploadFile(c);
break;default:c.bInProcess=!1,CWTaskManager.curTask=null,setTimeout(CWTaskManager.process,100),CWDataCenter.checkPendingTasks&&CWDataCenter.checkPendingTasks()}}}catch(a){CWDataCenter.exceptionHandler(a)}}},CWTask=function(){return function(){this.id="T"+(new Date).getTime();this.state=CWTaskState.FindPub;this.data=null;this.progress=0;this.bInProcess=this.bAddToLib=!1}}(),CWTaskState={FindPub:"findPub",CreatePub:"createPub",FindFile:"findFile",UploadFile:"uploadFile",Finished:"finished"};
