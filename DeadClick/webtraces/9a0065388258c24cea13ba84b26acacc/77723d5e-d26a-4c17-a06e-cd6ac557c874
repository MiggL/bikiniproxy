define(["jquery","domReady","wcs.context","moment","jquery.validate","wcs.validate-message","jquery-caret","jquery-textchange","promise!wcs.zmetrics"],function(h,f,m,n){var b=h("input.phone").data("format-as-you-type");h.validator.setDefaults({ignoreTitle:true,errorElement:"div",ignore:[]});h.validator.addMethod("pattern",function(p,o,q){if(h(o).hasClass("override-pattern-js")){return true}return this.optional(o)||new RegExp("^(?:"+q+")$").test(p)},STORE_MESSAGES.pattern);h.validator.addMethod("ageRequirement",function(x,t,q){var s=h.trim(x),z=h(t).data("format"),y=new Date();y.setFullYear(y.getFullYear()-13);if(s.length){switch(z){case"dd/MM/yyyy":var o=s.split("/"),r=o[0],v=o[1],w=o[2],u="/";s=v.concat(u,r,u,w);break;default:break}}var p=new Date(s);if(p<y){h(".dob-ss-textfield-js").val(n(p).format("YYYY-MM-DD"))}return this.optional(t)||(p<y)},STORE_MESSAGES.ageRequirement);h.validator.addMethod("nsc",function(s,q,v){var t=h(q),o=h(q.form),r=t.attr("pattern");if(t.hasClass("nsc-js")){var u=r.replace("[","[^");if(r.slice(-1)==="+"){u=u.slice(0,-1)}var p=s.match(new RegExp(u));if(p!==null){t.attr("title",p[0])}}return this.optional(q)||new RegExp("^(?:"+r+")$").test(s)},STORE_MESSAGES.nsc);h.validator.addClassRules("nsc-js",{nsc:true});h.validator.addMethod("hiddenRecaptcha",function(q,p,s){var r=h(p),o;if(r.hasClass("hiddenRecaptcha-js")&&!r.hasClass("ignored-js")){if(r.hasClass("giftcard-js")){o=grecaptcha.getResponse(giftcardRecaptcha)}else{if(r.hasClass("creditcard-js")){o=grecaptcha.getResponse(creditcardRecaptcha)}else{if(r.hasClass("pwreset-js")){o=grecaptcha.getResponse(pwResetRecaptcha)}else{o=grecaptcha.getResponse(logonRecaptcha)}}}if(o.length===0){return false}else{return true}}return true},STORE_MESSAGES.recaptcha);h.validator.addClassRules("hiddenRecaptcha-js",{hiddenRecaptcha:true});h.validator.addMethod("strictEmail",function(p,o,s){var r=h(o);if(r.hasClass("strict-email-js")){p=h.trim(p);var q=".con";if(p.indexOf(q,p.length-q.length)!==-1){return false}}return true},STORE_MESSAGES.strictEmail);h.validator.addClassRules("strict-email-js",{strictEmail:true});h.validator.addMethod("dob",function(p,o,q){return this.optional(o)||i(h(o).val(),h(o).data("format"))},STORE_MESSAGES.dob);h.validator.addClassRules("dob-textfield-js",{pattern:true,dob:true,ageRequirement:true});h.validator.addMethod("zipcode",function(s,o){var t=h(o),q=t.closest("form").find(".country-select-js"),p=t.closest("form").find('input[name="countryCode"]'),r=t.attr("pattern");if((q.length>0&&q.val()==="US")||(q.length<1&&p.val()==="US")){r=/^\d{5}(-\d{4})?$/;t.attr("title","Zip Code (99999 or 99999-9999)")}else{if((q.length>0&&q.val()==="CA")||(q.length<1&&p.val()==="CA")){r=/^[A-Za-z0-9]{3}\s?[A-Za-z0-9]{3}$/;t.attr("title","Zip Code (XXXXXX or XXX XXX)")}}if(r){return new RegExp(r).test(s)}return true},STORE_MESSAGES.pattern);h.validator.addClassRules("zipcode",{zipcode:true});function l(o){if((parseFloat(o)==parseInt(o))&&!isNaN(o)){return true}else{return false}}function k(o){h.ajax({url:"VFAjaxGetCityStateAPI",cache:true,dataType:"json",type:"GET",async:true,data:"zipcode="+o,success:function(q,r){h("#city-name").val(q.zc.city);var p=q.zc.sCode;if(p===""){h("#state-name").val(q.zc.state)}else{h('#state-name option[value="'+p+'"]').prop("selected","selected")}h("#state-name").change()},error:function(p,q){}})}function i(q,v){var s=true,y=q.split("/"),r=parseInt(y[0],10),p=parseInt(y[1],10),w=parseInt(y[2],10),o,x,u=w;if(v.charAt(0)=="d"){o=p;x=r}else{o=r;x=p}if(o<1||o>12){s=false}else{if(x<1||x>31){s=false}else{if((o==4||o==6||o==9||o==11)&&x==31){s=false}else{if(o==2){var t=(u%4===0&&(u%100!==0||u%400===0));if(x>29||(x==29&&!t)){s=false}}}}}return s}function d(q){var p={},o={};h.each(q,function(r,s){var t;if(t==/^DEFAULT_VALIDATION\.([^.]*)$/.exec(r)){method=t[1];p[method]=p[method]||{};p[method].defaultMessage=s}else{if(t==/^DEFAULT_VALIDATION\.([^.]*)\.([^.]*)$/.exec(r)){field=t[1];method=t[2];p[method]=p[method]||{};p[method].fields=p[method].fields||{};p[method].fields[field]=s}}});h.each(p,function(s,r){o[s]=function(w,t){var u=r.fields&&r.fields[t.name]||r.defaultMessage;var v=h(t).attr("title");if(u){u=u.replace(new RegExp("\\{title\\}","g"),(v?": "+v:""));return h.format(u,w)}}});h.extend(h.validator.messages,o)}function e(p){var o={groups:{},errorPlacement:""};if(p.is("#AssociateIdForm")){o.errorPlacement=function(q,r){return true}}if(p.hasClass("payment-cc-js")||p.hasClass("billing-address-js")){o.ignore="hidden"}h("input[data-group], select[data-group]",p).each(function(){var s=h(this).attr("data-group");var q=h(this).attr("name");var r=o.groups[s];if(r===undefined){o.groups[s]=q}else{o.groups[s]=r+" "+q}});h(".hiddenRecaptcha-js",p).each(function(){o.errorClass="error column"});o.success=function(q,r){return true};o.showErrors=function(s,u){var r,t;for(r=0;this.errorList[r];r++){var q=this.errorList[r];if(this.settings.highlight){this.settings.highlight.call(this,q.element,this.settings.errorClass,this.settings.validClass)}q.message=q.message.replace("{title}",q.element.title?": "+q.element.title:"");this.showLabel(q.element,"<span>"+q.message+"</span>")}if(this.errorList.length){this.toShow=this.toShow.add(this.containers)}if(this.settings.success){for(r=0;this.successList[r];r++){this.showLabel(this.successList[r])}}if(this.settings.unhighlight){for(r=0,t=this.validElements();t[r];r++){this.settings.unhighlight.call(this,t[r],this.settings.errorClass,this.settings.validClass)}}this.toHide=this.toHide.not(this.toShow);this.hideErrors();this.addWrapper(this.toShow).addClass("valid").show()};o.errorPlacement=function(q,r){if(r[0].type!="hidden"){q.insertAfter(r.parent().find(".icon-success"))}else{if(r.is("input[name=hiddenRecaptcha]")){q.insertAfter(r.siblings(".google-captcha-js"))}}};o.invalidHandler=function(s,r){if(r.numberOfInvalids()){h("html, body").animate({scrollTop:h(r.errorList[0].element).offset().top-100},1000)}for(var q=0;q<r.errorList.length;q++){var t={event:"formError",errorLocation:h(r.errorList[q].element).parent().find("label").text().replace("*","").trim(),errorMessage:r.errorList[q].message};zm.trackGeneric(t)}};o.highlight=function(s,q,r){if(s.type!="hidden"){var t=h(s).attr("id");h(s).addClass(q).removeClass(r);h(s.form).find("span[for="+t+"]").removeClass(r);if(h(s).parent().find("span.icon-success").length){h(s).parent().find("span.icon-success").removeClass(r)}else{if(s.type=="checkbox"){h('<span for="'+t+'" class="icon-success"></span>').appendTo(h(s).parent())}else{h('<span for="'+t+'" class="icon-success"></span>').insertAfter(h(s))}}if(h(s).parent().find("span.icon-error").length){h(s).parent().find("span.icon-error").addClass(r)}else{if(s.type=="checkbox"){h('<span for="'+t+'" class="icon-error valid"></span>').appendTo(h(s).parent())}else{h('<span for="'+t+'" class="icon-error valid"></span>').insertAfter(h(s))}}}};o.unhighlight=function(s,q,r){if(s.type!="hidden"){var t=h(s).attr("id");h(s).addClass(r).removeClass(q);h(s.form).find("span[for="+t+"]").addClass(r);if(h(s).parent().find("span.icon-success").length){h(s).parent().find("span.icon-success").addClass(r)}else{if(s.type=="checkbox"){h('<span for="'+t+'" class="icon-success valid"></span>').appendTo(h(s).parent())}else{h('<span for="'+t+'" class="icon-success valid"></span>').insertAfter(h(s))}}if(h(s).parent().find("span.icon-error").length){h(s).parent().find("span.icon-error").removeClass(r)}else{if(s.type=="checkbox"){h('<span for="'+t+'" class="icon-error"></span>').appendTo(h(s).parent())}else{h('<span for="'+t+'" class="icon-error"></span>').insertAfter(h(s))}}}};o.rules={state:{required:true},};o.onfocusout=function(q,r){if(!h(q).hasClass("disable-onfocusout-validate-js")){h(q).valid()}else{h(q).trigger("ONFOCUSOUT_VALIDATION_SKIPPED")}};return o}function a(r){var o=r,s="";o=r.replace(new RegExp("[-_]","g"),"");for(var q=0;q<o.length;q++){if(h.isNumeric(o.charAt(q))){s=s+o.charAt(q)}else{pos--}}for(var p=s.length;p<10;p++){s+="_"}if(s.length<3){s=s}else{if(s.length<6){s=s.substring(0,3)+"-"+s.substring(3,6)}else{s=s.substring(0,3)+"-"+s.substring(3,6)+"-"+s.substring(6,10)}}return s}function g(){h("input.phone").each(function(){var w=h(this),t=w.closest("form").find('input[name="formatPhoneWhileTyping"]'),v=j(w.val()),u=w.closest("form").find("#country");if(u.length>0&&WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")===true&&!(u.val()==="US"||u.val()==="CA")){}else{if(t.val()=="true"){w.val(v)}}});var r="form:not([data-abide]):not([data-vfdp-novalidate])";h(r).each(function(){h(this).validate(e(h(this)))});var q=h("#vf-my-account-profile-update-form").find("div").not(".form-notification-js").slice(1,3);if(h(q[0]).hasClass("reg-first-name-js")&&h(q[1]).hasClass("reg-last-name-js")){$wrapDivs=q.wrapAll("<div></div>");h(".reg-first-name-js").parent("div").addClass("cf")}if(WCS_CONFIG.get("zclookup::isZConfigured")===true){var p=h("#regExp").val();var s=new RegExp(p);var o=WCS_CONFIG.get("zclookup::zcLength");if(p&&o){h("input.zipcode").on("keyup change",function(w){var v=false,u=h(this).closest("form").find("#country");if(u.length>0&&WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")===true&&!(u.val()==="US"||u.val()==="CA")){v=true}var t=h(this).val();if(typeof s!="undefined"&&s.test(t)&&!v){t=t.replace(/[_\W]/g,"");k(t.substring(0,o))}})}}h("select.country-select-js").on("change",function(t){c(h(this))});h("input.zipcode").on("textchange",function(x){var w=h(this),u=w.closest("form").find(".country-select-js"),t=w.closest("form").find('input[name="countryCode"]'),v=w.val();if((u.length>0&&u.val()==="US")||(u.length<1&&t.val()==="US")){if(v.length>5&&v.charAt(5)!="-"){w.val(v.substring(0,5)+"-"+v.substring(5))}}});h("input.phone").on("keydown",function(x){var w=h(this);$countryField=w.closest("form").find("#country");if($countryField.length>0&&WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")===true&&!($countryField.val()==="US"||$countryField.val()==="CA")){return}var u,v,y,t=h(this).closest("form").find('input[name="formatPhoneWhileTyping"]');if(t.val()=="true"){if(x.which==8){x.preventDefault();u=h(this).val();v="";y=h(this).caret().start;if(h(this).caret().start==h(this).caret().end){v=u.substring(0,h(this).caret().start-1)+u.substring(h(this).caret().end);y--;if(y==4||y==8){y--}}else{v=u.substring(0,h(this).caret().start)+u.substring(h(this).caret().end);if(y==3||y==7){y++}}v=a(v);h(this).val(v).caret({start:y,end:y})}else{if(x.which==46){x.preventDefault();u=h(this).val();v="";y=h(this).caret().start;if(h(this).caret().start==h(this).caret().end){if(y==3||y==7){v=u.substring(0,h(this).caret().start+1)+u.substring(h(this).caret().end+2);y++}else{v=u.substring(0,h(this).caret().start)+u.substring(h(this).caret().end+1)}}else{v=u.substring(0,h(this).caret().start)+u.substring(h(this).caret().end);if(y==3||y==7){y++}}v=a(v);h(this).val(v).caret({start:y,end:y})}else{if(x.which==189){x.preventDefault()}}}}if(v==b&&w.hasClass("sts-format-phone")){w.prop("required",false)}}).on("textchange",function(){var y=h(this);$countryField=y.closest("form").find("#country");if($countryField.length>0&&WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")===true&&!($countryField.val()==="US"||$countryField.val()==="CA")){return}var w=h(this).val().replace(new RegExp("[-_]","g"),""),x="",z=h(this).caret().start,t=h(this).closest("form").find('input[name="formatPhoneWhileTyping"]');if(t.val()=="true"){for(var v=0;v<w.length;v++){if(h.isNumeric(w.charAt(v))){x=x+w.charAt(v)}else{z--}}for(var u=x.length;u<10;u++){x+="_"}if(z==3||z==7){z++}if(z==4&&w.length==4){z=5}if(z==8&&w.length==7){z=9}if(z>=12){z=12}h(this).val(x.substring(0,3)+"-"+x.substring(3,6)+"-"+x.substring(6,10)).caret({start:z,end:z})}}).on("focus",function(){var v=h(this);$countryField=v.closest("form").find("#country");var u=j(h(this).val()),t=h(this).closest("form").find('input[name="formatPhoneWhileTyping"]');if($countryField.length>0&&WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")===true&&!($countryField.val()==="US"||$countryField.val()==="CA")){if(u===b){h(this).val("")}}else{if(t.val()=="true"){h(this).val(u).caret({start:0,end:0})}}}).on("focusout",function(){var w=h(this);$countryField=w.closest("form").find("#country");if($countryField.length>0&&WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")===true&&!($countryField.val()==="US"||$countryField.val()==="CA")){return}var u=h(this).val().replace(new RegExp("[-_]","g"),""),v="",t=h(this).closest("form").find('input[name="formatPhoneWhileTyping"]');if(t.val()=="true"){if(u.length<3){v=u}else{if(u.length<6){v=u.substring(0,3)+"-"+u.substring(3,6)}else{v=u.substring(0,3)+"-"+u.substring(3,6)+"-"+u.substring(6,10)}}if(v==""&&w.hasClass("sts-format-phone")){w.prop("required",false)}h(this).val(v)}})}function j(p){var o=0;outputVal=p.replace(new RegExp("[-_() ]","g"),"");if(outputVal===0){return outputVal}while(o<12){if(o==3||o==7){outputVal=outputVal.substring(0,o)+"-"+outputVal.substring(o)}else{if(o>outputVal.length-1){outputVal+="_"}}o++}return outputVal}function c(q){var p=q.closest("form"),s=p.find("input[name=phone1]"),r,o;if(WCS_CONFIG.get("address::isRelaxedValidationRuleForCountryEnabled")!==true){return}if(q.val()==="US"||q.val()==="CA"){o=s.data("std-pattern");r=s.data("std-maxlength")}else{o=s.data("relaxed-pattern");r=s.data("relaxed-maxlength")}s.attr("pattern",o);s.attr("maxlength",r);s.blur()}f(function(){g();h(document).on("opened.fndtn.reveal",function(o){g()})});return{populateValidateFormMessageObjects:d,validation:g}});