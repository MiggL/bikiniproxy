define(["jquery","domReady","wcs.mini-list","wcs.context","wcs.utils","promise!wcs.lang-msg","pubsub"],function(e,d,c,b,a){topPanel={$topMiniCart:e(".topnav-minicart-panel, .global-cart-wishlist-panels-top-js"),$toggle:e(".unav-shoppingbag-js"),isMouseOrTouchEvent:this.touchType=window.navigator.pointerEnabled?"pointer":"ontouchstart" in window?"touch":"mouse",isOpen:false,autoHide:false,autoHideTime:parseInt(WCS_CONFIG.get("global::miniCartAutoHideTime")),cartMinHeight:parseInt(WCS_CONFIG.get("global::miniCartMinHeight")),autoHideTimer:"",toggleClick:function(){if(!topPanel.isOpen){topPanel.autoHide=false;topPanel.isOpen=true;topPanel.showTopMiniCart();topPanel.populateTopMiniCart(topPanel.autoHide);topPanel.autoHideTimer=a.startTimer(topPanel.hideTopMiniCart,topPanel.autoHideTime)}else{topPanel.isOpen=false;topPanel.hideTopMiniCart()}},getTouchType:function(){topPanel.isMouseOrTouchEvent=(this.touchType=window.navigator.pointerEnabled?"pointer":"ontouchstart" in window?"touch":"mouse");return topPanel.isMouseOrTouchEvent},getTopMiniCartType:function(){var f=(e(".topnav-cart").length>0?"cms":"ecom");return f},positionTopMiniCart:function(){var h=(e(window).width()-e(".master-header").innerWidth())/2,f,g;if(topPanel.getTopMiniCartType()==="cms"){f=0;g=e(".topnav-cart a").outerHeight()}else{f=h+10;g=topPanel.$toggle.outerHeight()-2}topPanel.$topMiniCart.css({opacity:0,right:f,top:g,minHeight:topPanel.cartMinHeight})},populateTopMiniCart:function(f,m,l,g){m=m||false;var h=ACTION_URLS.MINI_SHOPPING_URL,k=topPanel.$topMiniCart,j={storeId:b.getStoreId(),langId:b.getLangId(),catalogId:b.getCatalogId()},i={title:LANG_MSG["DEAFULT_MINICART.SHOPPING.title"],page:"shopcart",container:k.find(".shopcart.cart-list"),autoHide:f,isInit:m};if(e(".cart-item-slide-js").find(".cart-item-js").length===0||g==="SHOPCART_UPDATED"){c.renderMiniListItems(h,j,i,l)}else{c.initCarousel(i)}},showTopMiniCart:function(){topPanel.isOpen=true;a.stopTimer(topPanel.autoHideTimer);topPanel.$toggle.addClass("active active-js").siblings().not(".active-js").addClass("inactive inactive-js");topPanel.$topMiniCart.removeClass("hide").fadeTo(250,1,function(){topPanel.$topMiniCart.find(".cart-js").addClass("active-js")})},hideTopMiniCart:function(){topPanel.isOpen=false;a.stopTimer(topPanel.autoHideTimer);topPanel.$toggle.removeClass("active active-js").siblings().removeClass("inactive inactive-js");topPanel.$topMiniCart.find(".cart-js").removeClass("active-js");topPanel.$topMiniCart.fadeTo(250,0,function(){topPanel.$topMiniCart.addClass("hide").css("display","").find(".notification").addClass("hide")})},shopcartUpdateAction:function(h,g){var f=(g==="delete")?false:true;if(main.screen.size()!=="small"){topPanel.populateTopMiniCart(f,false,g,"SHOPCART_UPDATED")}},shopcartContentRenderComplete:function(g,f){if(f==="delete"){a.stopTimer(topPanel.autoHideTimer)}else{if(f!=="delete"&&f!=="init"){topPanel.showTopMiniCart();if(topPanel.getTopMiniCartType()==="cms"){topPanel.populateTopMiniCart()}topPanel.autoHideTimer=a.startTimer(topPanel.hideTopMiniCart,topPanel.autoHideTime);e(window).scrollTop(0)}}},initContentActions:function(){e.pubsub("subscribe","window.resize.breakpoint",function(f,g){topPanel.positionTopMiniCart()});e("body").delegate("#master-container, #modal","click touchstart",function(f){$target=e(f.target);if($target.parents(".global-cart-wishlist-panels-js").length>=1||$target.parents(".topnav-minicart-panel").length>=1){return}else{if((!$target.children(".nav-shoppingbag-qty-js"))||(!$target.hasClass("cart-js"))||(!$target.hasClass("unav-shoppingbag-js"))||(!$target.parents(".unav-shoppingbag-js"))||(!$target.hasClass("global-cart-wishlist-panels-js"))){if(e(".cart-js").hasClass("active-js")){topPanel.hideTopMiniCart()}}else{return}}}).delegate(".lower-container-js .has-dropdown-js","mouseenter",function(f){if(topPanel.$toggle.hasClass("active-js")){topPanel.hideTopMiniCart()}});topPanel.topPanelInteraction(topPanel.$toggle);topPanel.miniCartInteractions(topPanel.$topMiniCart,topPanel.$toggle)},miniCartInteractions:function(f){f.on({touchstart:function(g){if(topPanel.isOpen&&(topPanel.getTouchType()==="touch")){a.stopTimer(topPanel.autoHideTimer)}},touchend:function(g){if(topPanel.isOpen&&(topPanel.getTouchType()==="touch")){a.stopTimer(topPanel.autoHideTimer);topPanel.autoHideTimer=a.startTimer(topPanel.hideTopMiniCart,topPanel.autoHideTime)}},mouseenter:function(g){if(topPanel.isOpen&&(topPanel.getTouchType()!=="touch")){a.stopTimer(topPanel.autoHideTimer)}},mouseleave:function(g){if(topPanel.isOpen&&(topPanel.getTouchType()!=="touch")){topPanel.autoHideTimer=a.startTimer(topPanel.hideTopMiniCart,topPanel.autoHideTime)}}})},topPanelInteraction:function(f){f.on("mouseenter",function(g){if(topPanel.$toggle.hasClass("has-products")&&e.inArray(main.screen.size(),["large","xlarge"])>=0){g.preventDefault();topPanel.isOpen=false;topPanel.toggleClick()}else{if(topPanel.getTouchType()==="touch"){window.location.href=topPanel.$toggle.find(".btn-shoppingbag-js").attr("href")}}})},init:function(f){topPanel.positionTopMiniCart();if(e("body#checkout").length===0){topPanel.initContentActions()}e.pubsub("subscribe","EMAIL_ME_MY_CART_ACTION",function(){a.stopTimer(topPanel.autoHideTimer);e(topPanel.$topMiniCart).stop().fadeTo()});e.pubsub("subscribe","EMAIL_ME_MY_CART_FINISHED",function(){topPanel.autoHideTimer=a.startTimer(topPanel.hideTopMiniCart,topPanel.autoHideTime)});e(document).on("opened.fndtn.reveal",function(){topPanel.hideTopMiniCart()});e.pubsub("subscribe","vfdp.wcs.free_gift.offer_complete",function(){topPanel.toggleClick()});if(f){f()}},};return{init:topPanel.init,shopcartUpdateAction:topPanel.shopcartUpdateAction,shopcartContentRenderComplete:topPanel.shopcartContentRenderComplete}});