define(["jquery","pubsub","wcs.context","wcs.alert","promise!wcs.zmetrics","datalayer.wcs.mini-list","coremetrics.wcs.mini-list","promise!wcs.lang-msg",],function(f,v,o,k){var b=false,l=false,u=0,c=0,p=WCS_CONFIG.get("global::miniCartLocation"),d=(f(".topnav-header").length>0),w=(d||p==="top"),t=f(".topnav-minicart-panel, .global-cart-wishlist-panels-js"),e="";function h(y,A,x,z){if(w&&x.isInit===false){k.showLoadingNotification("p")}else{if(p==="right"){k.showLoadingNotificationByPosition("l",".global-cart-wishlist-panels-js")}}f.ajax({url:y,dataType:"html",data:A,success:function(B){}}).done(function(B){if(w){j(B,x,z)}else{j(B,x)}}).always(function(B){if(w&x.isInit===false){k.hideLoadingNotification()}else{if(p==="right"){k.hideLoadingNotificationByPosition(".global-cart-wishlist-panels-js")}}})}function r(N){var A=f(N.target),z=null;if(A.data("action")==="close"){if(w){if(A.parent().hasClass("notification")){A.parent().addClass("hide")}else{f(".unav-shoppingbag-js").trigger("click")}}else{f(".global-cart-wishlist-panels-js .tags .active").trigger("click");z=f(".global-cart-wishlist-panels-js .content .cart-list");f.each(z,function(){f(this).html("")})}}else{if(A.data("action")==="delete"||A.data("action")==="add to cart"){N.preventDefault();var L=A.parents(".cart-list"),O={title:L.find(".page-title").text(),page:L.data("tabcontent"),container:L},D=(A.data("action")==="add to cart")?LANG_MSG["DEFAULT_MINICART.MSG.movedToShoppingCart"]:undefined;var x=A.parents(".cart-item-js").find(".cart-item-row");var F="";x.find(".item-attr-js.defining").each(function(){F+=(F.length>0?" / ":"")+f(this).text()});var P=x.find(".product-info-js").data("seo-category");var C=false;var G=(C?$$.get(".product-listing-js").data("category-identifier"):"");var y=x.find(".product-info-js").data("bundle-partnumber");var E=x.find(".product-info-js").data("item-partnumber");var M=x.find(".product-info-js").data("master-category");var J=x.find(".product-info-js").data("parent-product-id");var I=x.find(".product-info-js").data("child-product-id");var K=x.find(".product-info-js").data("part-number");var B=x.find(".item-price-js").data("unit-price");var H={currency:WCS_CONFIG.get("global::currencyCode"),productName:x.find(".item-name-js").text().replace(/^\s+|\s+$/gm,""),productId:K?K:"",unitPrice:B?B:"",definingAttributes:f.trim(F),quantity:x.find(".item-qty-js").data("qty"),categoryId:G?G:"",masterCategoryId:M?M:"",childPartNumber:E?E:"",parentProductId:J?J:"",childProductId:I?I:"",bundlePartNumber:y?y:"",seoCategory:P?P:"",isQuickView:C,isSearch:(C&&G==="search")};s(A.attr("href"),O,D,A.data("action"),H);if(A.data("action")==="add to cart"){f.pubsub("publish","vfdp.wcs.mini_list.add_to_cart_clicked");zm.trackAddedItem(H)}}}}function i(){var x=t.children();if(d){f(".topnav-minicart").on("click",x,function(y){r(y)})}else{x.one("click",function(y){r(y)})}}function s(A,x,B,z,y){z=z||"remove";if(w){k.showLoadingNotification("p")}f.ajax({url:A,type:"POST",dataType:"html",success:function(C){if(x.page==="wishlist"){j(C,x,B,z);f.pubsub("publish","WISHLIST_UPDATED.remove",data={product:[{bundleId:y.bundlePartNumber,itemId:y.childPartNumber,name:y.productName,productId:y.productId}]});if(z==="add to cart"){if(f(".shopcart-js").length>0){window.location.href=f(".btn-shoppingbag-js").attr("href")}if(orderId){f(".wishlist-js").trigger("click");f.pubsub("publish","vfdp.wcs.mini_list.add_to_cart_succeeded",y)}}}else{if(x.page==="shopcart"&&z==="delete"&&orderId){f(".mini-cart-icon-close-js").trigger("click")}}var D=(z=="delete"||z=="remove")?"remove":"add";f.pubsub("publish","SHOPCART_UPDATED."+D,{product:[{bundleId:y.bundlePartNumber,itemId:y.childPartNumber,name:y.productName,productId:y.productId}],rewardEligibility:{orderId:orderId,rewardOptionEligible:rewardOptionEligible=="true"?true:false,rewardsAdded:false},action:z})}}).always(function(C){if(w){k.hideLoadingNotification()}})}function j(z,x,A,y){x.container.html(z);if(y==="add to cart"){x.container.find(".ajax-messaging").html('<p class="message success">'+A+"</p>")}t.find(".mini-cart-icon-close-js").on("click",function(){t.find(".tags .active").click()});a(x);i();f.pubsub("publish","MINICART_CONTENT_RENDER_COMPLETE",A)}function n(x){var y="";f.each(x,function(){var z=f(this)[0];y+="<p>"+z.name+": "+z.value+"</p>"});return y}function g(A,x){var y='<form class="cart-item-col" novalidate="novalidate"><select class="small" id="item-qty">';for(var z=1;z<(x+1);z++){if(A===z){y+='<option selected="selected" value="'+z+'">'+z+"</options>"}else{y+='<option value="'+z+'">'+z+"</options>"}}y+="</select></form>";return y}function q(O){var K=O.container.height(),E=0,R=O.container.find(".content-head"),M=parseInt(R.css("margin-top"),10),B=parseInt(R.css("margin-bottom"),10),D=R.find(".section-title"),A=parseInt(D.css("margin-top"),10),F=D.outerHeight(false),G=R.find(".page-title"),N=parseInt(G.css("margin-top"),10),S=G.outerHeight(false),L=O.container.find(".cart-actions, .wishlist-actions").outerHeight(true),C=0,P=0,z=0,I=O.container.find(".waved-line-sep"),x=parseInt(I.css("margin-top"),10),J=I.outerHeight(true);var y=Math.max(M,A);E=y+F+N+S+B;E=Math.max(y+B,E);var Q=O.container.find(".free-shipping-promo"),H=O.container.find(".mini-cart-promo-header");if(Q.length>0){C=parseInt(Q.css("margin-top"),10);P=Q.outerHeight(false);z=parseInt(Q.css("margin-bottom"),10)}else{if(H.length>0){H.each(function(){var T=f(this);if(T.parents(".cart-item-container-js").length>0){return false}else{C=parseInt(T.css("margin-top"),10);P=parseInt(T.parents(".espot-container").outerHeight(false));z=parseInt(T.parents(".espot-container").find("p").css("margin-bottom"),10)}})}}P=C+P+z;return K-E-L-J-P+Math.min(z,x)}function m(z){var A=z.container.find(".cart-item-slide-js").outerHeight(true),y=q(z);if(w){var x=z.container.find(".cart-item-js").length;A=z.container.find(".cart-item-js").outerHeight(true);y=A*Math.min(2,x);z.container.find(".cart-item-container-js").css({height:y+"px"});if(x>2){if(z.container.find(".cart-item-nav").hasClass("hide")){z.container.find(".cart-item-nav").removeClass("hide")}}else{if(!z.container.find(".cart-item-nav").hasClass("hide")){z.container.find(".cart-item-nav").addClass("hide");z.container.find(".cart-item-slide-js").css("top","")}}}else{if(y>=A){z.container.find(".cart-item-container-js").css("height",y+"px");if(!z.container.find(".cart-item-nav").hasClass("hide")){z.container.find(".cart-item-nav").addClass("hide");z.container.find(".cart-item-slide-js").css("top","")}}else{z.container.find(".cart-item-container-js").css("height",(y-70)+"px");if(z.container.find(".cart-item-nav").hasClass("hide")){z.container.find(".cart-item-nav").removeClass("hide")}}}}function a(z){m(z);z.container.find(".cart-item-nav.prev").on("click",function(){if(!f(this).hasClass("ready")){return false}if(f(this).hasClass("disabled")){return false}var B=y(f(this).closest(".cart-list").find(".cart-item-slide-js")),A=f(this).closest(".cart-list").find(".cart-item").outerHeight(true);f(this).removeClass("ready");f(this).closest(".cart-list").find(".cart-item-nav.next").removeClass("disabled");f(this).closest(".cart-list").find(".cart-item-slide-js").animate({top:"+="+Math.min(-B,A)},300,function(){f(this).closest(".cart-list").find(".cart-item-nav.prev").addClass("ready");var C=y(f(this).closest(".cart-list").find(".cart-item-slide-js"));if(C>=0){f(this).closest(".cart-list").find(".cart-item-nav.prev").addClass("disabled")}})});z.container.find(".cart-item-nav.next").on("click",function(){if(!f(this).hasClass("ready")){return false}var D=z.container.find(".cart-item-slide-js").outerHeight(false),A=z.container.find(".cart-item-container-js").outerHeight(true),E=y(f(this).closest(".cart-list").find(".cart-item-slide-js")),C=f(this).closest(".cart-list").find(".cart-item-js").outerHeight(true),B;if(D+parseInt(E)<=A){return false}newTop=D+parseInt(E)-C;B=(newTop<=A)?C-(A-newTop):C;f(this).removeClass("ready");f(this).closest(".cart-list").find(".cart-item-nav.prev").removeClass("disabled");f(this).closest(".cart-list").find(".cart-item-slide-js").animate({top:"-="+B},300,function(){f(this).closest(".cart-list").find(".cart-item-nav.next").addClass("ready");var G=z.container.find(".cart-item-slide-js").outerHeight(true),F=z.container.find(".cart-item-container-js").outerHeight(true);var H=y(f(this).closest(".cart-list").find(".cart-item-slide-js"));if(G+parseInt(H)<=F){f(this).closest(".cart-list").find(".cart-item-nav.next").addClass("disabled")}})});z.container.find(".cart-item-container-js").on({wheel:x,touchstart:function(B){var A=f(this).closest(".cart-list").find(".cart-item-slide-js");A.stop();b=true;u=B.originalEvent.touches[0].clientY;c=y(A)},touchmove:function(G){l=true;G.preventDefault();var D=f(this).closest(".cart-list").find(".cart-item-slide-js"),B=f(this).closest(".cart-list").find(".cart-item-container-js"),H=D.outerHeight(true),A=B.outerHeight(true),J=G.originalEvent.touches[0].clientY-u,E=c+J,I=Math.min(0,A-H),C=z.container.find(".cart-item-nav.prev"),F=z.container.find(".cart-item-nav.next");if(E<0&&E>I){D.css("top",E+"px");if(C.hasClass("disabled")){C.removeClass("disabled")}if(F.hasClass("disabled")){F.removeClass("disabled")}}else{if(E>=0){D.css("top",(E/2)+"px");if(!C.hasClass("disabled")){C.addClass("disabled")}}else{if(E<=I){D.css("top",(E/2+I/2)+"px");if(!F.hasClass("disabled")){F.addClass("disabled")}}}}},touchend:function(G){if(b&&l){var F=f(this).closest(".cart-list").find(".cart-item-slide-js"),C=f(this).closest(".cart-list").find(".cart-item-container-js"),D=F.outerHeight(true),A=C.outerHeight(true),B=A-D,E=y(F);if(E>0||A-D>0){F.animate({top:"0px"},400)}else{if(E<A-D){F.animate({top:B+"px"},400)}}}b=false;l=false;u=G.originalEvent.changedTouches[0].clientY}});z.container.on({touchmove:function(A){A.preventDefault()}});f(document).on("mousewheel",x);function y(B){var A=B.css("top")||"auto";if(A=="auto"){A="0px"}return parseFloat(A.replace(/[^-\d\.]/g,""))}function x(C){var B=f(C.target);if(B.hasClass("cart-item-container-js")||B.parents(".cart-item-container-js").length>0){var A=-C.originalEvent.deltaY,D=Math.max(-1,Math.min(1,A));if(D<0){if(!z.container.find(".cart-item-nav.next").hasClass("hide")&&!z.container.find(".cart-item-nav.next").hasClass("disabled")){z.container.find(".cart-item-nav.next").trigger("click")}}else{if(D>0){if(!z.container.find(".cart-item-nav.prev").hasClass("hide")&&!z.container.find(".cart-item-nav.prev").hasClass("disabled")){z.container.find(".cart-item-nav.prev").trigger("click")}}}return false}else{return true}}f(window).on("resize",function(){m(z);var B=z.container.find(".cart-item-slide-js").outerHeight(true),A=q(z);var C=y(z.container.find(".cart-item-slide-js"));if(B+parseInt(C)<A-50){z.container.find(".cart-item-nav.next").addClass("disabled")}else{z.container.find(".cart-item-nav.next").removeClass("disabled")}})}return{renderMiniListItems:h,initCarousel:m}});