define(["jquery","wcs.mini-list","wcs.mobile-panel","wcs.context","wcs.alert","wcs.utils","promise!wcs.lang-msg","pubsub","promise!wcs.zmetrics"],function(d,c,f,b,e,a){(function(k,j,g,l){var h="minicart";var i=function(n,m){this.element=n;this.options=m;this.metadata=k(this.element).data("minicart-options")};i.prototype={defaults:{wishlistPanel:"#wishlist-notification-panel",topnav:".topnav-header",topnavWrapper:"div.topnav",cartWishlistPanel:".global-cart-wishlist-panels-js, .topnav-minicart-panel",cmsTopNavMiniCart:".topnav-minicart",rightMiniCartPanel:".mini-cart-section.l-right"},init:function(){console.log("Initilizing minicart functions");this.config=k.extend({},this.defaults,this.options,this.metadata);var n=this;var m;n.isCMSTopNav=(n.element===k(n.config.topnavWrapper)[0]);n._miniCartLocation=WCS_CONFIG.get("global::miniCartLocation");n.autoHideTime=parseInt(WCS_CONFIG.get("global::miniCartAutoHideTime"));n.mobileGenericMessage=WCS_CONFIG.get("global::miniCartMobileGenericMessage");n.mobileShowAsModal=WCS_CONFIG.get("global::miniCartMobileShowAsModal");n.shopcartButtonText=WCS_CONFIG.get("PDP::pdpMobileCTAButtonText");n.overlayVisible=false;n.manuallyClosed=false;n.isSmallScreen=(main.screen.size()==="small");n.notificationTimer="";n.$wishListURL=k(".add-to-wishlist-js").attr("data-wishlist-url");n.$globalBodyOverlay=k("#global-body-overlay");n.$shopcartURL=k(".btn-shoppingbag-js, .topnav-cart a").attr("href");n._build();n.isTopMiniCart=(n._miniCartLocation==="top"||n.isCMSTopNav);n.$globalCartWishlistPanels=k(n.config.cartWishlistPanel);n.$miniCartPanels=k("#global-cart-wishlist-panels, .topnav-minicart-panel");if(k("body#checkout").length!==0){return}if(n.isTopMiniCart){require(["wcs.top-panel"],function(o){m=o;n.initializeMinicartComponents();n.minicartUpdateShopcartEvents();n.updateContentEvents()})}else{n.initializeMinicartComponents();n.minicartUpdateShopcartEvents();n.updateContentEvents()}n.events();return n},events:function(){var m=this;k("body").on("click",m,m.miniCartGlobalClickHandler)},initializeMinicartComponents:function(){var m=this;if(m.isSmallScreen){f.init()}else{if(m.isTopMiniCart){topPanel.init()}else{require(["wcs.right-panel"],function(n){m.$globalCartWishlistPanels.rightPanels()})}}},showMinicartPanel:function(){var m=this;if(m.isSmallScreen){m.toggleOverlay();m.$globalCartWishlistPanels.find(".notification").html(html).removeClass("hide");m.$globalCartWishlistPanels.removeClass("hide");if(!m.isTopMiniCart){m.$globalCartWishlistPanels.show()}k("html,body").animate({scrollTop:0},"fast")}else{m.$globalCartWishlistPanels.show();m.$globalCartWishlistPanels.removeClass("hide")}},hideMinicartPanel:function(){var m=this;if(m.isSmallScreen){m.$globalCartWishlistPanels.find(".notification").addClass("hide");if(m.isTopMiniCart){m.$globalCartWishlistPanels.addClass("hide")}else{m.$globalCartWishlistPanels.fadeOut()}m.toggleOverlay()}else{m.$globalCartWishlistPanels.hide();m.$globalCartWishlistPanels.addClass("hide")}},getProductName:function(n){var m=this;n=n||{};if(Array.isArray(n.product)){return n.product[0].name}else{if(typeof n.product==="object"&&typeof n.product.name==="string"){return n.product.name}}if(k("body.wishlist, body.wishlist-shared").length>0){return m._getProductNameFromWishlistPage(n)}if(k(".product-form-js").length>0){return m._getProductNameFromProductForm()}if(k(".custom-order-item-form-js").length>0){return m._getProductNameFromDYOForm()}},_getProductNameFromWishlistPage:function(m){if(m&&m.productName){return m.productName}},_getProductNameFromProductForm:function(){return k(".product-form-js .attr-box.selected img").attr("data-product-name")},_getProductNameFromDYOForm:function(){var m=k(".custom-order-item-form-js").data("product-name");if(m.length<=0&&k(".breadcrumb-product-name").length>0){m=k(".breadcrumb-product-name").text()}return m},minicartUpdateShopcartEvents:function(){var m=this;k.pubsub("subscribe","SHOPCART_UPDATED",function(o,n){n=n||{};productName=m.getProductName(n);if(m.isSmallScreen){if(!f.shopcartUpdateCheck){return}}else{if(n.action==="delete"){m.removeMessage("shopcart");if(m.isTopMiniCart){topPanel.shopcartUpdateAction(o,n.action)}return}}if(m.isTopMiniCart){topPanel.shopcartUpdateAction(o,n.action)}if(m.isSmallScreen){html=m.showMessage("add-to-cart",productName);m.manuallyClosed=false;a.stopTimer(m.notificationTimer);m.showMinicartPanel();k(m.$globalCartWishlistPanels).one("click",".mini-cart-icon-close-js",function(){m.$globalCartWishlistPanels.fadeOut();m.toggleOverlay(true)});m.notificationTimer=a.startTimer(function(){m.hideMinicartPanel()},m.autoHideTime)}})},updateContentEvents:function(){var m=this,o,p,n;k.pubsub("subscribe","WISHLIST_UPDATED",function(r,q){if(q==="delete"){m.removeMessage("wishlist")}else{if(m.isSmallScreen){o=k(".product-info-container-js").not(".cloned").find("h1.product-info-js:not(.hide)").text();p=k(".notification",m.config.wishlistPanel);n=m.showMessage("add-to-wishlist",o,m.$wishListURL);a.stopTimer(m.notificationTimer);p.html(n);k(m.config.wishlistPanel).show()}}});k.pubsub("subscribe","MINICART_CONTENT_RENDER_COMPLETE",function(s,q){if(m.isTopMiniCart){topPanel.shopcartContentRenderComplete(s,q)}var r=k(".reveal-modal",m.$miniCartPanels);if(k("*[data-reveal-id]",m.$miniCartPanels).length>0){r.each(function(t,v){var u=k(v);if(k("body > #"+u.attr("id")).length<=0){k("body").append(u)}})}k(".share-cart-js",m.$miniCartPanels).click(function(){k(".tags .active",m.$miniCartPanels).click()});if(WCS_CONFIG.get("global::miniCartVisaCheckoutEnabled")){k.pubsub("publish","VISA_CHECKOUT_CONTENT_READY")}if(k(".email-me-my-cart-form-container-js").length>0){require(["wcs.email-me-my-cart"],function(){k(".email-me-my-cart-form-container-js").emailMeMyCart()})}if(k(".apple-pay-button").length>0){require(["wcs.applepay-button"],function(){k(".apple-pay-button").applePay()})}});if(k(".email-me-my-cart-form-js").length>0&&m.isSmallScreen){k.pubsub("subscribe","ORDER_ID_UPDATED",function(q,r){k('.email-me-my-cart-email-only-form.email-me-my-cart-form-js input[name="orderId"]').val(r.orderId)})}k.pubsub("subscribe","EMAIL_ME_MY_CART_ACTION",function(){a.stopTimer(m.notificationTimer)});k.pubsub("subscribe","EMAIL_ME_MY_CART_FINISHED",function(){var q=m.$globalCartWishlistPanels.find(".notification");autoHideTimer=a.startTimer(function(){m.hideMinicartPanel()},m.autoHideTime)});k.pubsub("subscribe","vfdp.wcs.free_gift.offer_loading",function(){k(".cart-js.mini-cart-tag-shopcart.active").trigger("click")});k.pubsub("subscribe","vfdp.wcs.product_form.add_to_cart_succeeded",function(){if(m._miniCartLocation==="right"&&main.screen.size()!=="small"){k(".cart-js.mini-cart-tag-shopcart:not(.active)").trigger("click")}});k.pubsub("subscribe","vfdp.wcs.wishlist.add_to_cart_succeeded",function(){if(m._miniCartLocation==="right"&&main.screen.size()!=="small"){k(".cart-js.mini-cart-tag-shopcart:not(.active)").trigger("click")}});k.pubsub("subscribe","vfdp.wcs.free_gift.offer_complete",function(){if(m._miniCartLocation==="right"&&main.screen.size()!=="small"){k(".cart-js.mini-cart-tag-shopcart:not(.active)").trigger("click")}})},showMessage:function(s,t,v){var w=this,r,u,o,n,m,q=WCS_CONFIG.get("PDP::pdpMobileCTACheckoutEnabled"),p='<div class="mini-cart-action-go-to-checkout-container"><a href="'+w.$shopcartURL+'" class="mini-cart-action-go-to-checkout button primary">'+w.shopcartButtonText+"</a></div>";if(s==="add-to-cart"){u=LANG_MSG["MOBILE_SHOP_CART.MSG.successfullyAdded"];o=LANG_MSG["MOBILE_SHOP_CART.MSG.successfullyAdded2"];n=LANG_MSG["MOBILE_SHOP_CART.MSG.successfullyAdded3"];if(w.mobileGenericMessage){r='<div class="icon-close mini-cart-icon-close-js" data-action="close"></div><div class="notification-text"><h2><i class="icon-shopcart"></i>'+u+'</h2><p class="shopping-cart-text">'+o+"</p></div>"}else{r='<div class="icon-close mini-cart-icon-close-js" data-action="close"></div><div class="notification-text"><span>'+u+'</span><span> </span><span class="product-name">'+t+"</span><span> </span><span>"+o+'</span><span> </span><span class="shopping-cart-text">'+n+"</span></div>"}if(q){r+=p}}else{if(s==="add-to-wishlist"){u=LANG_MSG["MOBILE_WISH_LIST.MSG.successfullyAdded"];o=LANG_MSG["MOBILE_WISH_LIST.MSG.successfullyAdded2"];n=LANG_MSG["MOBILE_WISH_LIST.MSG.successfullyAdded3"];r=(v?'<a href="'+v+'" class="notification-text">':"")+"<span>"+u+'</span><span> </span><span class="product-name">'+t+"</span><span> </span><span>"+o+'</span><span> </span><span class="shopping-cart-text">'+n+"</span>"+(v?"</a>":"")}else{if(s==="remove-wishlist"||s==="remove-shopcart"){m=(s==="remove-wishlist")?LANG_MSG["DEFAULT_MINICART.MSG.removedFromWishlist"]:LANG_MSG["DEFAULT_MINICART.MSG.removedFromShoppingCart"];r='<div class="icon-close mini-cart-icon-close-js" data-action="close"></div><div class="notification-text"><span>'+m+"</span></div>"}}}return r},removeMessage:function(q){var m=this;if(m.isTopMiniCart){var o=(q==="wishlist")?"remove-wishlist":"remove-shopcart",n=m.showMessage(o),p=m.$globalCartWishlistPanels.find(".notification");a.stopTimer(m.notificationTimer);p.html(n).removeClass("hide")}},toggleOverlay:function(m){var n=this;if(n.mobileShowAsModal||n.isCMSTopNav){if(!n.manuallyClosed){if(n.overlayVisible){k(n.$globalBodyOverlay).fadeOut(500).delay(500).css({width:"0%"})}else{k(n.$globalBodyOverlay).hide().css({width:"100%"}).fadeIn(500)}if(m){n.manuallyClosed=true}n.overlayVisible=!n.overlayVisible}}else{return}},miniCartGlobalClickHandler:function(s){var r=s.data,n,t,o;$target=k(s.target);if((r._miniCartLocation==="right")&&($target.hasClass("cart-js")&&$target.hasClass("active-js"))||($target.parents().hasClass("cart-js")&&$target.parents().hasClass("active-js"))){n=ACTION_URLS.MINI_SHOPPING_URL;t={storeId:b.getStoreId(),langId:b.getLangId(),catalogId:b.getCatalogId()};o={title:LANG_MSG["DEAFULT_MINICART.SHOPPING.title"],page:"shopcart",container:k(".global-cart-wishlist-panels-js .shopcart.cart-list")};c.renderMiniListItems(n,t,o)}else{if(($target.hasClass("wishlist-js")&&$target.hasClass("active-js"))||($target.parents().hasClass("wishlist-js")&&$target.parents().hasClass("active-js"))){n=ACTION_URLS.MINI_WISHLIST_URL;t={storeId:b.getStoreId(),langId:b.getLangId()};o={title:LANG_MSG["DEAFULT_MINICART.WISHLIST.title"],page:"wishlist",container:k(".global-cart-wishlist-panels-js .wishlist.cart-list")};c.renderMiniListItems(n,t,o)}else{if($target.parents(".remove-item-js").length>0){var q=$target.parents(".cart-item-js").find(".cart-item-row"),m="";q.find(".item-attr-js").each(function(){m+=(m.length>0?" / ":"")+k(this).text()});var p={currency:WCS_CONFIG.get("global::currencyCode"),productName:q.find(".item-name-js").text().replace(/^\s+|\s+$/gm,""),productId:q.find(".product-info-js").data("part-number"),itemId:q.find(".product-info-js").data("item-partnumber"),bundleId:q.find(".product-info-js").data("bundle-partnumber"),unitPrice:q.find(".item-price-js").data("unit-price"),definingAttributes:k.trim(m),quantity:q.find(".item-qty-js").data("qty"),isProductRemoval:true};zm.trackRemovedItem(p)}}}},_build:function(){var m=this;if(m.isCMSTopNav){k(m.config.rightMiniCartPanel).remove();m._miniCartLocation="top";if(k(m.config.cmsTopNavMiniCart).length===0){k(m.element).append('<section class="topnav-minicart"><div class="topnav-minicart-panel hide"><div class="topnav-minicart-notification notification hide"></div><div class="topnav-minicart-content"><div class="topnav-minicart-content-container shopcart cart-list" data-tabcontent="shopcart"></div></div></div></section>')}}}};i.defaults=i.prototype.defaults;k.fn.minicart=function(m){return this.each(function(){var n=k(this).data(h);if(!n){n=new i(this,m).init();k(this).data(h,n)}})}})(jQuery,window,document)});