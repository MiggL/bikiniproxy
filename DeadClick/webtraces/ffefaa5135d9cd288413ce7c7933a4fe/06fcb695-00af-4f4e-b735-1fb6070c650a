define(["jquery","domReady","wcs.context","wcs.text","wcs.utils","wcs.alert","wcs.find-in-store-util","pubsub","wcs.net"],function(G,j,w,D,h,g,H,B,c){var s,f,k,O,e=false,J=false,d={},q=G("#shipToStoreRadius").attr("data-radius-uom")||"",C=q.split("|"),a={};var S=function(V,Y){var X=G.Deferred(),U=G.Deferred(),W=G.Deferred();l();u();o(V,Y).done(function(Z){s=Z;U.resolve(s)});G.when(U).done(function(){p().done(function(Z){f=Z;W.resolve(f)}).fail(function(){if(G(".ship-to-store-radius-js").val()!=="100"){G.pubsub("publish","NO_STORES_WITHIN_RADIUS")}if(G(".ship-to-store-radius-js").val()==="100"){Q()}})});G.when(W).done(function(){X.resolve(R.combineData());g.hideLoadingNotification()});return X.promise()};function u(){G("#search-stores").on("click",function(){J=false})}function K(U){d=U}function P(U){a=U}function r(){e=false}function n(V){var U=window.location.href,X,W;V=V.replace(/[\[\]]/g,"\\$&");X=new RegExp("[?&]"+V+"(=([^&#]*)|&|#|$)");W=X.exec(U);if(!W){return null}if(!W[2]){return""}return decodeURIComponent(W[2].replace(/\+/g," "))}function t(V){var U=V.length,W=[],Y={},Z;for(var X=0;X<U;X++){Z=V[X];Y[Z]=Y[Z]>=1?Y[Z]+1:1;if(Y[Z]>=2){W.push(Z)}}return W}function I(X){var V=[],U={},W=G(".attr-color-js").attr("data-attribute-id");Object.keys(X).map(function(Y){if(W!==Y){Object.keys(a.attributes).map(function(Z,aa){a.attributes[Z].map(function(ac,ab){if(X[Y]==ac.display){ac.catentryId.forEach(function(ae,ad){V.push(ae.toString())})}})})}});return V}function z(X,U){var W=[],V=Object.keys(d).length;if(V==1){W=X}else{if(V>2){W=t(U)}else{W=U}}return W.toString()}function i(V){var W=G(".find-store-container-js .find-retail-store-catentryid-js").val(),U;if(V.length>0){V=V.replace(/^,|,$/g,"")}U={retailStoreClientkeyFilterList:V,catentryString:z(W,I(d)),selectedCatentry:W};return y(U).promise()}function x(U){var W=G(".find-store-container-js .find-retail-store-catentryid-js").val(),V;if(U.length>0){U=U.replace(/^,|,$/g,"")}V={retailStoreEnterpriseStoreIdentifierFilterList:U,catentryString:z(W,I(d)),selectedCatentry:W};return y(V).promise()}function y(V){var U=G.Deferred();G.ajax({type:"GET",url:G(".find-a-store-form-js").attr("data-oms-instoreAvailability-url"),data:V,cache:false}).done(function(W){e=W.omsUnreachableError;if(e===true){U.reject()}else{U.resolve(W)}}).fail(function(W){Q()});return U}function M(){G(".ship-to-store-radius-js").val(G(".ship-to-store-radius-js option:last").val());G("#search-stores").click();J=true}var l=function(){s=undefined;f=undefined;k=undefined;O=undefined};function o(Y,V){var ad=G.Deferred(),ah="^(\\+|\\-)?[0-9]+(.[0-9]+)?$",X=WCS_CONFIG.get("PDP::w2giServerApiEnabled");if(X){var aa=G(".find-a-store-form-js").attr("data-w2gi-server-api-url"),ac=Y?G(".ship-to-store-radius-js option:last").val():G(".ship-to-store-radius-js").val(),af=(F()!==null&&F()!==undefined)?F():"",ae=b()?b().split("-")[0]:"",ag=af.split(","),W={radius:ac};if(V&&G('input[name="shipToStoreZip"]').val()!==""){W.addressLine=G('input[name="shipToStoreZip"]').val()}else{if(Y&&ae!==""){W.addressLine=ae}else{if(Y&&ag.length>1&&ag[0].match(ah)&&ag[1].match(ah)){W.latLong=af}else{W.addressLine=""}}}g.showLoadingNotification("p");G.ajax({type:"GET",url:aa,dataType:"xml",data:W,}).done(function(ai){ai=N(ai);ad.resolve(ai)}).fail(function(ai){console.error(ai);g.hideLoadingNotification()})}else{var ab=E(Y,V).split("?"),U=ab[0],Z=ab[1];g.showLoadingNotification("p");G.ajax({type:"POST",url:U,dataType:"xml",data:Z,}).done(function(ai){ai=N(ai);ad.resolve(ai)}).fail(function(ai){console.error(ai);g.hideLoadingNotification()})}return ad.promise()}function N(X){var V=G(X),U=V.find("response").attr("code"),Z=V.find("poi"),Y=G(".find-a-store-form-js").attr("data-enable-filter"),W;k=[];k=m(Z);if(WCS_CONFIG.get("BOPIS::bopisEnabled")){O=[];O=A(Z)}if(Y!="true"){W=h.xmlToJson(X);return W}else{L(Z).done(function(aa){if(aa.errorMessage!==null){}else{W=h.xmlToJson(X);return W}})}}function Q(){g.hideLoadingNotification();G("#find-store-container .store-results-list-js").html('<div class="alert-box alert">'+LANG_MSG["PDP.STORE_INVENTORY.MSG.noStores"]+"</div>")}function m(U){G(U).each(function(V,W){k+=(k===""?"":",")+D.safeString(G(W).find("clientkey").text())});return k}function A(U){G(U).each(function(V,W){O+=(O===""?"":",")+D.safeString(G(W).find("enterprise_store_identifier").text())});return O}function p(){var V=G.Deferred();var U=n("findOMSInventory");if(k.length===0){V.reject();if(J){Q()}return V.promise()}if((WCS_CONFIG.get("PDP::pdpInstoreOMSInventoryCheckEnabled")||(U!==null&&U==="true"))&&(e===false)){i(k).done(function(W){V.resolve(W)}).fail(function(){if(e===true){v(k).done(function(W){V.resolve(W)})}})}else{if(WCS_CONFIG.get("BOPIS::bopisEnabled")||(U!==null&&U==="true")&&(e===false)){x(O).done(function(W){V.resolve(W)}).fail(function(){if(e===true){v(O).done(function(W){V.resolve(W)})}})}else{v(k).done(function(W){V.resolve(W)})}}return V.promise()}function v(V){var U=G.Deferred(),W;if(WCS_CONFIG.get("BOPIS::bopisEnabled")){W="&retailStoreEnterpriseStoreIdentifierFilterList="+O}else{W="&retailStoreClientkeyFilterList="+V}G.ajax({type:"GET",url:G(".find-a-store-form-js").attr("data-instoreAvailability-url")+"&catentryId="+G(".find-store-container-js .find-retail-store-catentryid-js").val()+W,dataType:"json",cache:false}).done(function(X){U.resolve(X)}).fail(function(X){Q()});return U}function F(){return w.getCookie("Edgescape-Lat-Long")}function b(){return w.getCookie("Edgescape-Zip")}function L(W){var V=[];G.each(W,function(Y,X){var Z=G(X).find("clientkey").text();V[Y]=Z});var U=G("form.get-active-store-js");G('input[name="stloc_id"]',U).val(V.toString());return c.submitForm(U)}var R=(function(){var V={},W=[],U;V._combineDataInNewObject=function(){var X=s.response.collection;if(!X){return s}X.storeColumnTitle=LANG_FIND_IN_STORE.RETAIL_STORE_IN_STORE_COL_TITLE;X.storeCheckBox=LANG_FIND_IN_STORE.RETAIL_STORE_INVENTORY_STORE_AVAILABILITY_CHECKBOX;X.storeChoose=LANG_FIND_IN_STORE.RETAIL_STORE_INVENTORY_STORE_CHOOSE_BUTTON;X.stockColumnTitle=LANG_FIND_IN_STORE.RETAIL_STORE_IN_STOCK_COL_TITLE;X.resultsText=LANG_FIND_IN_STORE.RETAIL_STORE_RESULTS_TEXT;X.outOfStockText=LANG_FIND_IN_STORE.RETAIL_STORE_INVENTORY_OUT_OF_STOCK;X.viewMoreCollapsed=LANG_FIND_IN_STORE.RETAIL_STORE_MORE_BUTTON_TEXT_COLLAPSED;X.viewMoreExpanded=LANG_FIND_IN_STORE.RETAIL_STORE_MORE_BUTTON_TEXT_EXPANDED;X.currentLocation=LANG_FIND_IN_STORE.RETAIL_STORE_CURRENT_LOCATION;G(X.poi).each(function(Z,aa){var Y=this._distance["#text"];this.googleMapLink=H.getGoogleMapsLink(V._buildAddressStringForGoogleMaps(this),X.currentLocation);this.weekdayHours=V._getMondayThroughFriday(Z,this);this.inventory=V._getInventory(this,f.inventory);this.appendValue=V._appendCookieName(this);this.storeIdentifier=V._storeCookieValue(this);this.storeZipValue=V._storeZipValue(this);this.productAttributes=f.productInfo.attributes;this.productImage=f.productInfo.productImage;this.productName=f.productInfo.productName;this.storeMessageTitle=LANG_FIND_IN_STORE.RETAIL_STORE_IN_STORE_TITLE;this.storeMessage=LANG_FIND_IN_STORE.RETAIL_STORE_IN_STORE_DESCRIPTION;this.getDirections=LANG_FIND_IN_STORE.RETAIL_STORE_FIND_STORE_GET_DIRECTIONS;this.saturday=LANG_FIND_IN_STORE.RETAIL_STORE_SATURDAY;this.sunday=LANG_FIND_IN_STORE.RETAIL_STORE_SUNDAY;this.monfri=LANG_FIND_IN_STORE.RETAIL_STORE_MONDAY_FRIDAY;this.storeHours=LANG_FIND_IN_STORE.RETAIL_STORE_FIND_STORE_HOURS;this.resultClass=V._getResultClass(Z);this.radiusUOM=T(Y)});return X};V._getInventory=function(Z,aa){var ab,Y;var X=WCS_CONFIG.get("PDP::w2giStoreField");G(aa).each(function(ac,ad){if(WCS_CONFIG.get("BOPIS::bopisEnabled")){Y=Z.enterprise_store_identifier["#text"]}else{if(WCS_CONFIG.get("PDP::w2gicatalogStoreIdCheck")){if(X==="enterprise_store_identifier"){Y=Z.enterprise_store_identifier["#text"]}else{Y=Z.storenumber["#text"]}}else{Y=Z.clientkey["#text"]}}if(aa[ac].retailStore===Y){ab=aa[ac]}});return ab};V._buildAddressStringForGoogleMaps=function(X){var Y=G.isEmptyObject(X.name["#text"])?"":X.name["#text"]+", ";Y+=G.isEmptyObject(X.address1["#text"])?"":X.address1["#text"]+" ";Y+=G.isEmptyObject(X.address2["#text"])?"":X.address2["#text"]+" ";Y+=G.isEmptyObject(X.city["#text"])?"find-in-store-alt-colors.js":X.city["#text"]+", ";Y+=G.isEmptyObject(X.state["#text"])?"":X.state["#text"]+" ";Y+=G.isEmptyObject(X.postalcode["#text"])?"":X.postalcode["#text"];return Y};V._getResultClass=function(X){if(X<4){return"initial"}else{return"hidden"}};V._appendCookieName=function(ab){var X,Y=LANG_FIND_IN_STORE.RETAIL_STORE_INVENTORY_YOUR_STORE,ad=WCS_CONFIG.get("BOPIS::bopisFavStore")+w.getStoreId(),Z=w.getCookie(ad),ac=ab.postalcode["#text"],aa=typeof(ab.enterprise_store_identifier)!=="undefined"?ab.enterprise_store_identifier["#text"]:"";if(Z===aa){if(ac){w.setCookie("USER_ENTERED_ZIP",ac);X=Y}}return X};V._storeCookieValue=function(X){esi=typeof(X.enterprise_store_identifier)!=="undefined"?X.enterprise_store_identifier["#text"]:"";return esi};V._storeZipValue=function(X){postCode=X.postalcode["#text"];return postCode};V._getMondayThroughFriday=function(X,Z){var Y;areEqual=true;W=[];try{W.push({day:LANG_FIND_IN_STORE.RETAIL_STORE_MONDAY,hours:Z.m["#text"]})}catch(aa){}try{W.push({day:LANG_FIND_IN_STORE.RETAIL_STORE_TUESDAY,hours:Z.t["#text"]})}catch(aa){}try{W.push({day:LANG_FIND_IN_STORE.RETAIL_STORE_WEDNESDAY,hours:Z.w["#text"]})}catch(aa){}try{W.push({day:LANG_FIND_IN_STORE.RETAIL_STORE_THURSDAY,hours:Z.thu["#text"]})}catch(aa){}try{W.push({day:LANG_FIND_IN_STORE.RETAIL_STORE_FRIDAY,hours:Z.f["#text"]})}catch(aa){}U=W.length;for(Y=0;Y<U;Y++){if(W[Y].hours!==W[0].hours){areEqual=false}}if(!areEqual){W.htmlClass="hidden";return W}else{return Z.m}};return{combineData:V._combineDataInNewObject}}());function E(at,ag){var af=G(".find-a-store-form-js").attr("data-w2gi-url"),ar=G(".find-a-store-form-js").attr("data-w2gi-appkey"),ap=G(".find-a-store-form-js").attr("data-w2gi-limit"),ah=G(".find-a-store-form-js").attr("data-w2gi-where-clause-brand"),ae=at?G(".ship-to-store-radius-js option:last").val():G(".ship-to-store-radius-js").val(),V=WCS_CONFIG.get("PDP::pdpInStoreW2GICountryCode"),an=T(),ai=an.length>0?"<radiusuom>"+an+"</radiusuom>":"",Z=WCS_CONFIG.get("PDP::w2giAddWhereClauseFilterStores"),ak=WCS_CONFIG.get("PDP::w2giStoreField"),al=WCS_CONFIG.get("PDP::w2gifetchBrandStores"),am=WCS_CONFIG.get("PDP::w2gifetchOutletStores"),aa=WCS_CONFIG.get("PDP::w2gifetchAuthorizedDealers"),ab=WCS_CONFIG.get("PDP::w2gifetchSummitSeries");var ad=F()?F().split(","):["",""];var U=b()?b().split("-")[0]:"";var ao="^(\\+|\\-)?[0-9]+(.[0-9]+)?$",aq="<geolocs><geoloc>";if(ag&&G('input[name="shipToStoreZip"]').val()!==""){aq+="<addressline>"+G('input[name="shipToStoreZip"]').val()+"</addressline>"}else{if(at&&U!==""){aq+="<addressline>"+U+"</addressline>"}else{if(at&&ad[0].match(ao)&&ad[1].match(ao)){aq+="<longitude>"+ad[1]+"</longitude>";aq+="<latitude>"+ad[0]+"</latitude>"}else{aq+="<addressline></addressline>"}}}aq+="<country>"+V+"</country>";aq+="</geoloc></geolocs>";var Y="";var X=Z===true?"<"+ak+"><notlike>''</notlike></"+ak+">":"";var au=al===true?"<"+ah+"><eq>1</eq></"+ah+">":"";var W=am===true?"<outletstore><eq>1</eq></outletstore>":"";var aj=aa===true?"<retailstore><eq>1</eq></retailstore>":"";var ac=ab===true?"<summit><eq>1</eq></summit>":"";if(ah===""){au=al===true?"TRUE":"";W=am===true?"TRUE":"";aj=aa===true?"TRUE":""}if(ah!==""){Y=["<request>","<appkey>"+ar+"</appkey>",'<formdata id="locatorsearch">',"<dataview>store_default</dataview>","<order>_distance</order>","<softmatch>1</softmatch>","<limit>"+ap+"</limit>","<atleast>1</atleast>","<searchradius>"+ae+"</searchradius>",ai,aq,"<stateonly>1</stateonly>","<nobf>1</nobf>","<where>",X,"<or>",au,W,aj,ac,"</or>","<country><eq>"+V+"</eq></country>","</where>","</formdata></request>"]}else{Y=["<request>","<appkey>"+ar+"</appkey>",'<formdata id="locatorsearch">',"<dataview>store_default</dataview>","<order>_distance</order>","<softmatch>1</softmatch>","<limit>"+ap+"</limit>","<atleast>1</atleast>","<searchradius>"+ae+"</searchradius>",ai,aq,"<stateonly>1</stateonly>","<nobf>1</nobf>","<where>",X,"<tnvn><eq></eq></tnvn>","<country><eq>"+V+"</eq></country>","<or>","<off><eq>"+au+"</eq></off>","<out><eq>"+W+"</eq></out>","<aut><eq>"+aj+"</eq></aut>","</or></where></formdata></request>"]}af=af+encodeURIComponent(Y.join(""));return af}function T(U){var V=C[1];if(U&&(parseFloat(U)!==1)){V=C[0]}return V}return{getStoreData:S,resubmitWithMaxRadius:M,setProductSelection:K,setProductAvailabilityJSON:P,resetOMSFindInStoreError:r}});