define(["jquery","jquery.hoverintent","wcs.topbar-helper","jquery-mobile-events","fastclick","pubsub"],function(f,e,d,a,c,b){c.attach(document.body);(function(k,j,g,l){var i="topbarCore";var h=function(n,m){this.element=n;this.options=m;this.metadata=k(this.element).data("topbar-options")};h.prototype={defaults:{hoverDelay:[WCS_CONFIG.get("topnav::navHoverDelay"),WCS_CONFIG.get("topnav::navHoverDelay")],spaceBetweenLogoAndNav:30,tappable:false},init:function(){var m=this;m.config=k.extend({},m.defaults,m.options,m.metadata);m.config.currentScreenSize=main.screen.size();m.findElements();m._build();m.drawMenu();if(k("> .has-dropdown-js:hover",m.$topbarLower).length>0){m.openDropdown(k("> .has-dropdown-js:hover",m.$topbarLower))}m.events();this.initSmallCartButton();this.initPromoCarousel();this.initProductCarousel();this.initTopbarUtil();return m},_build:function(){var m=this;m.removeBackArrows();m.initStackedList()},findElements:function(){this.$masterHeader=k(this.element);this.$topbar=this.$masterHeader.find(".top-bar-js, .top-bar-acord-js");this.$titleArea=this.$topbar.find(".title-area");this.$topbarLower=this.$topbar.find(".lower");this.$topbarLowerContainer=this.$topbar.find(".lower-container-js");this.$backButton=this.$topbar.find(".title.back");this.$moreLinksContainer=this.$topbarLower.find(".more-links-container-js");this.$moreLink=this.$topbarLower.find(".gnav-more");this.$searchForm=this.$masterHeader.find(".search-form-container .search-input-container");this.$searchButton=this.$masterHeader.find(".search-form-container .postfix.search-button")},drawLargeMenu:function(){this.setNavigationItems();this.enableCustomStyleForAll();this.enableCustomStyleForMoreLink();if(this.$moreLinksContainer.find(".more-link-js").length){this.calculateMoreContainerWidth(this.$moreLinksContainer)}},drawSmallMenu:function(){this.disableCustomStyle();this.resetNavigationItems();this.hideMoreMenu()},hideMoreMenu:function(){this.$moreLink.addClass("hide")},removeBackArrows:function(){if(WCS_CONFIG.get("topnav::dropdownBackButtonNoArrow")===true){this.$backButton.each(function(){var m=k(this);m.html(m.html().replace(/\Â« /g,""))})}},initStackedList:function(){if(WCS_CONFIG.get("topnav::dropdownStackedList")===true){var m,n;if(WCS_CONFIG.get("topnav::dropdownStackedListConfigEnabled")===true){m="data-sub-cat-col-row";n="data-sub-cat-col-container"}else{m="id";n="data-sub-cat-id"}this.$topbarLower.find("> .has-dropdown-js").each(function(){var o=k(this),p=o.find(".sub-cat-lists-js");$stackedLists=p.find(".stacked-list-js");$stackedLists.each(function(){var s=k(this),q=s.attr(m),r=s.clone().children().addClass("stacked-list show-for-medium-up");p.find("["+n+'="'+q+'"]').append(r)})})}},getMoreLinkWidth:function(){var m=this,o=0,n=m.$moreLink.hasClass("hide");m.$moreLink.removeClass("hide");o=d.outerWidthFix(m.$moreLink);if(n){m.$moreLink.addClass("hide")}return o},getSearchWidth:function(){var n=this,m=0;if(WCS_CONFIG.get("topnav::navHeaderExcludeSearch")===true){return m}if(n.$searchForm.is(":visible")===true){m+=d.outerWidthFix(n.$searchForm)}if(n.$searchButton.is(":visible")===true){m+=d.outerWidthFix(n.$searchButton)}return m},getLogoWidth:function(){var n=this,m=0,o=main.screen.size();if(o==="small"||o==="medium"){if(WCS_CONFIG.get("topnav::navHeaderLogoSeparateLineTabletEnabled")===true){return m}}else{if(WCS_CONFIG.get("topnav::navHeaderLogoSeparateLineDesktopEnabled")===true){return m}}if(this.$titleArea.is(":visible")===true){m+=d.outerWidthFix(n.$titleArea)}m+=n.config.spaceBetweenLogoAndNav;return m},getMaxNavWidth:function(){var n=this,p=n.$topbar.width(),q=n.$topbarLowerContainer.width(),m=n.getLogoWidth(),o=n.getSearchWidth();p-=m;p-=o;p=Math.min(p,q);return p},getAvailableNavWidth:function(n){var m=this,o=n||m.getMaxNavWidth();m.$topbarLower.find("> li:not(.more-link-js)").each(function(){o-=d.outerWidthFix(k(this))});return o},hideMenuItem:function(m){m.removeClass("visible-nav-item").addClass("hidden-nav-item");return m},showMenuItem:function(m){m.removeClass("hidden-nav-item").addClass("visible-nav-item");return m},setNavigationItems:function(){var n=this,t=n.$topbarLower.find("> li.more-link-js"),m=[];n.emptyMoreLinkContents();n.$moreLink.removeClass("hide");t.each(function(){var u=k(this);m.push(d.outerWidthFix(u));return m});t.each(function(){var u=k(this);n.hideMenuItem(u)});var s=n.getMoreLinkWidth(),r=n.getMaxNavWidth(),q=n.getAvailableNavWidth(r);t.each(function(u,w){var x=k(this),v=m[u];if(q>=v){n.showMenuItem(x);q-=v}else{return false}});var p=n.$topbarLower.find(".hidden-nav-item");if(p.length==1){var o=m.slice(-1)[0];if(q+s>=o){n.showMenuItem(p);n.$moreLink.addClass("hide")}}if(p.length<=0){n.$moreLink.addClass("hide")}n.$topbarLower.find(".visible-nav-item").each(function(){n.refreshItemsInMainNav(k(this))});n.$topbarLower.find(".hidden-nav-item").each(function(){n.refreshItemsInMoreNav(k(this))});n.$topbarLowerContainer.css({overflow:"visible"});n.$topbarLower.css({"max-width":r,"min-width":0,width:"auto"})},emptyMoreLinkContents:function(){if(WCS_CONFIG.get("topnav::navHeaderIncludeDropdownsInMore")===true){this.$moreLinksContainer.empty()}},refreshItemsInMainNav:function(o){var m=false,n=o.text();this.$moreLinksContainer.find(".more-link-js").filter(function(){if(k(this).text()===n){m=true;k(this).remove()}});this.toggleMoreLinksDropdown()},refreshItemsInMoreNav:function(p){var n=p.clone(),m=false,o=p.text();this.$moreLinksContainer.find(".more-link-js").filter(function(){if(k(this).text()===o){m=true}});if(!(m)&&main.screen.size()!=="small"){n.prependTo(this.$moreLinksContainer)}this.toggleMoreLinksDropdown()},toggleMoreLinksDropdown:function(){if(WCS_CONFIG.get("topnav::navHeaderExcludeMore")===true){if(this.$moreLinksContainer.find(".more-link-js").length){this.$moreLink.removeClass("hide");this.calculateMoreContainerWidth(this.$moreLinksContainer)}else{this.$moreLink.addClass("hide")}}},calculateMoreContainerWidth:function(o){if(WCS_CONFIG.get("topnav::navHeaderExcludeMore")===true){var m=0,n=parseInt(o.css("padding"))*2;o.find(".more-link-js").each(function(){var s=k(this),q=k(".sub-category",s),p=parseInt(q.css("min-width")),r=q.outerWidth(),t=Math.max(p,r);s.css("width",t);m+=t});m+=n;o.css("width",m)}},resetNavigationItems:function(){this.$topbarLower.css({"min-width":"","max-width":"",width:""})},events:function(){var m=this,o=k("> .has-dropdown-js",m.$topbarLower),n=k("> a:not(.has-dropdown .has-dropdown > a)",o);$moreLinksContainerItems=k(".more-links-container-js .more-link-js > a");$moreLinksContainerItems.on("click",function(p){var q=k(this).attr("href");k(location).attr("href",q)});n.on("touchend",function(q){var p=k(this);m.config.tappable=true;if(main.screen.size()!=="small"){q.preventDefault();q.stopPropagation();m.simulateHover(p.parent())}});o.hoverIntent({over:function(r){var p=main.screen.size(),q=k(this);if(p!=="small"){if(!m.config.tappable){m.openDropdown(q)}}},out:function(r){var p=main.screen.size(),q=k(this);if(p!=="small"){if(!m.config.tappable){m.closeDropdown(q)}}},timeout:m.config.hoverDelay});m.disableDoubleClicks();k.pubsub("subscribe","window.resize",function(p,q){if(q&&q.now){m.config.currentScreenSize=q.now;m.drawMenu()}if(m.config.currentScreenSize!=="small"){m.setNavigationItems()}})},drawMenu:function(){var m=this;k("> .has-dropdown-js",m.$topbarLower).each(function(){m.closeDropdown(k(this))});if(m.config.currentScreenSize==="small"){m.drawSmallMenu()}else{m.drawLargeMenu()}m.resetDropdown()},simulateHover:function(n){var m=this;if(n.hasClass("hover")){m.closeDropdown(n)}else{m.openDropdown(n)}},enableCustomStyleForAll:function(){var m=this;this.$topbarLower.find("> .has-dropdown-js:not(.gnav-more)").each(function(){m.enableCustomStyle(k(this))})},enableCustomStyle:function(n){var m;if(WCS_CONFIG.get("topnav::navHeaderIncludeDropdownsInMore")===true){m=".dropdown:not(.mini-list)"}else{m=".dropdown"}n.children(m).addClass("dropdown-custom-style").find(".has-dropdown-js").addClass("mega").end().find(".has-dropdown-js").removeClass("has-dropdown-js").end().find(".dropdown").addClass("mega2").end().find(".dropdown").removeClass("dropdown");k(".moved").removeClass("moved")},enableCustomStyleForMoreLink:function(){if(this.$moreLink.length<1){return}if(this.$moreLinksContainer.length<1){return}var m=this.$moreLink[0].getBoundingClientRect().right,n=this.$moreLinksContainer.outerWidth();if(m<n){this.$moreLinksContainer.css("right",(m-n)+"px")}else{this.$moreLinksContainer.css("right","")}},disableCustomStyle:function(){var m=this.$topbarLower.find("> .has-dropdown-js").children(".dropdown");m.find(".mega").addClass("has-dropdown-js");m.find(".mega").removeClass("mega");m.find(".mega2").addClass("dropdown");m.find(".mega2").removeClass("mega2");m.removeClass("dropdown-custom-style");m.css("cssText","")},initProductCarousel:function(){var m=this,n=k(".header-nav-carousel-js",m.$topbarLower);maxSlides=0;if(n.length<=0){return false}if(main.screen.size()==="small"){return false}if(k(".ui-carousel-container",m.$topbarLower).length>0){return false}k(n).each(function(){maxSlides=Math.max(maxSlides,k(this).find("li").length)});if(maxSlides<=1){return false}require(["jquery-carousel"],function(o){k(n).each(function(){if(k(this).find("li").length>1){k(this).carousel({identifier:"ui-carousel-header",bullets:false,responsive:false})}})})},setGroupHeight:function(s,r,n){var m,q,p=[];if(r!==null||r!==""){q=r}else{q=null}s.not(q).each(function(){p.push(k(this).height())});if(n=="max"){var o=Math.max.apply(Math,p);m=(o>0)?o+"px":""}else{if(n=="inherit"){m=""}}s.not(q).each(function(){k(this).height(m)})},openDropdown:function(p){var n=this;p.siblings(".has-dropdown-js").each(function(){var q=k(this);n.closeDropdown(q)});if(WCS_CONFIG.get("topnav::dropdownStackedList")===true&&k("ul.dropdown",p).hasClass("stacked")){n.setGroupHeight(k(".sub-cat-lists-js > li",p),".stacked-list-js","max")}var m=k("body").outerWidth(),o=-p.offset().left;if(!p.hasClass("has-dropdown-custom-js")){p.children(".dropdown:not(.mini-list)").css({width:m+"px",left:o+"px",top:this.$topbarLower.outerHeight()+"px"})}if(!p.data("is-dropdown-shown")){p.find(".dropdown, .dropdown-arrow").show(0);p.data("is-dropdown-shown",true);p.addClass("hover");n.lazyloadDropdown(p)}},resetDropdown:function(){this.$topbarLower.find(".dropdown, .dropdown-arrow",".has-dropdown-js").css("display","")},closeDropdown:function(m){m.removeClass("hover");if(m.data("is-dropdown-shown")){m.find(".dropdown, .dropdown-arrow").hide(0);m.data("is-dropdown-shown",false)}},lazyloadDropdown:function(m){m.find("img.lazy").each(function(){var n=k(this);n.attr("src",n.data("original"))})},initPromoCarousel:function(){var m=k("#espot-header");if(m.length>0){require(["wcs.promo-carousel"],function(n){m.promoCarousel()})}},disableDoubleClicks:function(){if(WCS_CONFIG.get("topnav::accordionMenuEnabled")!==false){return}this.$topbarLower.on("click",function(n){var m=k(this);if(m.hasClass("js-state-processing")){n.preventDefault();n.stopImmediatePropagation();return}m.addClass("js-state-processing");setTimeout(function(){m.removeClass("js-state-processing")},600)})},initTopbarUtil:function(){var m=k(".topnav-util-js");if(m.length>0){require(["wcs.topbar-util"],function(n){m.topbarUtility()})}},initSmallCartButton:function(){var m=k(".cart-topbar-js");if(m.length>0){require(["wcs.topbar-smallscreen-cart"],function(n){k(".cart-topbar-js").topbarSmallCart()})}}};h.defaults=h.prototype.defaults;k.fn.topbarCore=function(m){return this.each(function(){var n=k(this).data(i);if(!n){n=new h(this,m).init();k(this).data(i,n)}})}})(jQuery,window,document)});