define(["vfdp-s7-viewer.helpers","vfdp-s7-viewer.config","vfdp-s7-viewer.sdk",],function(a,d){s7sdk.Util.lib.include("s7sdk.common.Container");s7sdk.Util.lib.include("s7sdk.set.MediaSet");s7sdk.Util.lib.include("s7sdk.set.Swatches");s7sdk.Util.lib.include("s7sdk.set.SetIndicator");s7sdk.Util.init();var b="VFDPS7Viewer";var c=function(f,e){if(f[b] instanceof c){return f[b]}this.element=f;this.options=e||{};this.eventHandelersAdded=false;this.sdk_ready=false;this.metadata=JSON.parse(this.element.getAttribute("data-viewer-options"));this.config=new d();this.config.setConfig(this.options,this.metadata);this.Viewer={};this.viewerContainerId="hero-image-container";this.swatchContainerId="swatches-container";this.setIndicatorContainerId="set-indicator-container";c.numInstances=(c.numInstances||0)+1;this.instanceIndex=c.numInstances-1;this.init();this.element[b]=this;this.viewerConfig=[];return this};c.prototype={init:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.CONFIG){console.log("VFDPS7Viewer.prototype.init")}var e=this,h=this.config.getMediaSet();this.currentSize=a.getScreenSize();this.params=new s7sdk.ParameterManager();this.element.id=this.element.id||a.getUniqueId();this.viewerContainer=this.element.querySelectorAll("#"+this.viewerContainerId)[0];this.viewerContainer.id=this.element.id+"-"+this.viewerContainerId;this.swatchContainer=this.element.querySelectorAll("#"+this.swatchContainerId)[0];this.swatchContainer.id=this.element.id+"-"+this.swatchContainerId;this.setIndicatorContainer=this.element.querySelectorAll("#"+this.setIndicatorContainerId)[0];this.setIndicatorContainer.id=this.element.id+"-"+this.setIndicatorContainerId;var f=this.element.getElementsByClassName("viewer-wrapper")[0],i=f.className,g=this.config.getConfig().Swatches;f.className=i.replace(/(^|\s)alt-image-\S+/," alt-image-"+g.position);this.params.addEventListener(s7sdk.Event.SDK_READY,function(j){e.SDKReady()},false);this.params.push("Swatches.resizable","0");this.params.push("serverurl",h.serverurl);this.params.push("videoserverurl",h.videoserverurl);this.params.push("contenturl",h.contenturl);this.params.push("MediaSet.asset",h.asset);this.params.push("MediaSet.labelkey","label");this.params.setLocalizedTexts(this.config.getI18n());this.params.init()},SDKReady:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.CONFIG){console.log("VFDPS7Viewer.prototype.SDKReady",this.sdk_ready)}if(this.sdk_ready){return}this.sdk_ready=true;this.initMediaSet();this.initContainer();this.addEventHandlers()},initMediaSet:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.initMediaSet")}var e=this;if(this.mediaSet){this.updateMediaSet();return}this.mediaSet=new s7sdk.set.MediaSet(null,this.params,this.element.id+"-mediaSet");this.mediaSet.addEventListener(s7sdk.event.AssetEvent.NOTF_SET_PARSED,function(f){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINER){console.log("s7sdk.event.AssetEvent.NOTF_SET_PARSED",f)}e.onMediaSetParsed(f)},false)},initContainer:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.initContainer")}if(this.ViewerContainer){return}var e=this,g=[];while(this.element.firstChild){g.push(this.element.removeChild(this.element.firstChild))}this.ViewerContainer=new s7sdk.common.Container(this.element.id,this.params,this.element.id+"-vfdp-viewer-wrapper");for(var f=0;f<g.length;f++){this.ViewerContainer.component.innerContainer.appendChild(g[f])}this.Container=new s7sdk.common.Container(this.viewerContainer.id,this.params,this.viewerContainer.id+"-image-viewer");this.Container.addEventListener(s7sdk.event.StatusEvent.NOTF_VIEW_READY,function(h){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINER){console.log("s7sdk.event.StatusEvent.NOTF_VIEW_READY",h)}a.map(e.Viewer,function(l,i){if(e.Viewer[i].isActiveViewer){var j=e.Viewer[i].Viewer.component.getCurrentAsset();if(j.parent===e.mediasetDesc){var k=e.mediasetDesc.items.indexOf(j);e.setViewerActiveIndex(k);e.setSelectedSwatch(k)}}})},false)},initViewer:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.initViewer")}if(Object.keys(this.Viewer).length){var e=this.getViewerActiveIndex();this.setViewerActiveIndex(e);this.updateCurrentView(this.mediasetDesc.items[e]);return}this.setViewerActiveIndex(this.getViewerActiveIndex());this.mediaTypes=[];this.viewerTypes=[];var f=this;a.map(this.mediasetDesc.items,function(l,j){var k=f.getMediaType(l);a.map(f.config.getSizes(),function(n,o){var m=f.config.getConfig(n).Viewer.type[k];if(f.mediaTypes.indexOf(k)===-1&&m){f.mediaTypes.push(k)}if(m&&f.viewerTypes.indexOf(m)===-1){f.viewerTypes.push(m)}})});var h=this.mediasetDesc.items[this.getViewerActiveIndex()];var g=this.viewerTypes.length;a.map(this.viewerTypes,function(k,j){require(["vfdp-s7-viewer."+k],function(l){f.Viewer[k]=new l(f.config,f.Container,f.params);f.Viewer[k].setItem(h);if(f.Viewer[k].type.indexOf(h.type)!==-1){f.Viewer[k].queue(function(){f.fadeOutPreloadedImage()})}f.Viewer[k].queue(function(){g--;if(!g){f.element.setAttribute("data-viewer-state","ready");var m=document.createEvent("Event");m.initEvent("init.viewer.complete.ready",true,true);document.dispatchEvent(m)}})})});var i=document.createEvent("Event");i.initEvent("init.viewer.complete",true,true);document.dispatchEvent(i)},initSwatches:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.initSwatches")}if(this.Swatches){this.Swatches.setMediaSet(this.mediasetDesc);this.updateSwatches();return}var e=this;this.Swatches=new s7sdk.set.Swatches(this.swatchContainer.id,this.params,this.swatchContainer.id+"-vfSwatches");this.Swatches.setMediaSet(this.mediasetDesc);this.Swatches.addEventListener(s7sdk.event.AssetEvent.SWATCH_SELECTED_EVENT,function(f){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINER){console.log("s7sdk.event.AssetEvent.SWATCH_SELECTED_EVENT",f)}e.swatchSelected(f)},false);this.updateSwatches()},initSetIndicator:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.initSetIndicator")}this.SetIndicator=new s7sdk.set.SetIndicator(this.setIndicatorContainer.id,this.params,this.setIndicatorContainer.id+"set_indicator");this.SetIndicator.setNumberOfPages(this.mediasetDesc.items.length)},destroy:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.destroy")}if(this.destroyed){return}var f=[];while(this.ViewerContainer.component.innerContainer.firstChild){f.push(this.ViewerContainer.component.innerContainer.removeChild(this.ViewerContainer.component.innerContainer.firstChild))}for(var e=0;e<f.length;e++){this.element.appendChild(f[e])}this.ViewerContainer.dispose();this.removeEventHandlers();a.map(this.Viewer,function(g){g.destroy()});this.Swatches.dispose();this.Container.dispose();this.params.dispose();this.swatchContainer.id=this.swatchContainerId;this.viewerContainer.id=this.viewerContainerId;c.numInstances=c.numInstances-1;this.destroyed=true},updateMediaSet:function(e){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.updateMediaSet")}e=e||this.config.getMediaSet("asset");if(this.mediaSet.component.asset!==e){this.mediaSet.setAsset(e)}},updateMediaSetIndex:function(e){var h=e||parseInt(this.config.getMediaSet("index")),g=this.mediasetDesc.items.length-1,f=h>g?g:h;this.setViewerActiveIndex(f);this.updateCurrentView(this.mediasetDesc.items[f]);this.setSelectedSwatch(f);this.setSelectedIndicator(f)},updateViewer:function(f){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.updateViewer",f)}var g=this.config.getConfig().Viewer,e=this;a.map(this.Viewer,function(i,h){if(!e.viewerConfig[h]||JSON.stringify(e.viewerConfig[h].modifiers)!==JSON.stringify(g[h].modifiers)){e.Viewer[h].setModifier(g[h].modifiers)}e.viewerConfig[h]=g[h]});this.updateCurrentView(f);this.containerResize()},updateCurrentView:function(f){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.updateCurrentView",f)}if(!f){return}var e=this;a.map(this.Viewer,function(h,g){e.Viewer[g].setItem(f)})},updateSwatches:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.updateSwatches",i)}var e=this,i,g,l,j=!this.Swatches&&!this.config.getMode("swatches"),f=this.Swatches&&!this.config.getMode("swatches"),h=this.config.getMode("swatches")&&!this.Swatches,k=this.config.getMode("swatches")&&this.Swatches;if(j){return}i=this.config.getConfig().Swatches;g=this.element.getElementsByClassName("viewer-wrapper")[0];l=g.className;if(f){this.Swatches.hide();g.className=l.replace(/(^|\s)alt-image-\S+/," alt-image-none");return}if(h){this.initSwatches();this.fadeOutPreloadedImage();return}if(k){this.Swatches.show()}g.className=l.replace(/(^|\s)alt-image-\S+/," alt-image-"+i.position);if(!this.swatchConfig||JSON.stringify(this.swatchConfig.position)!==JSON.stringify(i.position)){if(i.position=="left"||i.position=="right"){this.Swatches.setModifier({tmblayout:"1,0"})}else{this.Swatches.setModifier({tmblayout:"0,1"})}}if(!this.swatchConfig||JSON.stringify(this.swatchConfig.modifiers)!==JSON.stringify(i.modifiers)){e.Swatches.setModifier(i.modifiers)}this.setSelectedSwatch();this.swatchConfig=i},setSelectedSwatch:function(e){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.setSelectedSwatch",e)}if(typeof e=="undefined"){e=this.getViewerActiveIndex()||0}if(this.SetIndicator){this.SetIndicator.setSelectedPage(e)}if(!this.Swatches){return}if(e&&this.Swatches.component.hasOwnProperty("swatches_")&&e>=this.Swatches.component.swatches_.length){e=this.Swatches.component.swatches_.length-1}this.Swatches.selectSwatch(-1,true);this.Swatches.component.itemIndex_=e;this.setSwatchPage();if(this.Swatches.component.swatches_[e]&&this.Swatches.component.swatchGroup_){this.Swatches.component.currentSwatch_=this.Swatches.component.swatches_[e];this.Swatches.component.currentSwatch_.setSelected(true)}},getMediaType:function(f){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.getMediaType",f)}var e=f.type;for(var g in s7sdk.ItemDescType){if(s7sdk.ItemDescType.hasOwnProperty(g)){if(s7sdk.ItemDescType[g]===e){return g}}}},getViewerActiveIndex:function(){var e=this.config.getMediaSet("index");var f=this.mediasetDesc.items.length-1;return e>f?f:e},setViewerActiveIndex:function(e){e=e||0;this.config.setConfig({media:{set:{index:e}}});var f=document.createEvent("CustomEvent");f.initCustomEvent("viewer.activeIndex.change",false,false,{activeIndex:e});window.dispatchEvent(f)},addEventHandlers:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.addEventHandlers")}var e=this;if(!this.eventHandelersAdded){window.addEventListener("resize",function(g){e.onWindowResize()},false);this.ViewerContainer.addEventListener("click",function(g){if(g.target.hasOwnProperty("button")&&g.target.button instanceof s7sdk.common.FullScreenButton){e.onClickFullScreen()}if(g.target.getAttribute("class")==="s7dot"){e.indicatorPageChange(g)}});this.ViewerContainer.addEventListener(s7sdk.event.ResizeEvent.FULLSCREEN_RESIZE,function(g){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINER){console.log("s7sdk.event.ResizeEvent.FULLSCREEN_RESIZE",g)}if(e.ViewerContainer.isFullScreen()){if(a.getScreenSize()!==e.currentSize){e.ViewerContainer.cancelFullScreen()}}e.containerResize();if(!e.ViewerContainer.isFullScreen()){a.map(e.Viewer,function(h){h.ControlBar.FullScreenButton.setSelected(false)})}},false);this.Container.addEventListener(s7sdk.event.ResizeEvent.COMPONENT_RESIZE,function(g){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("s7sdk.event.ResizeEvent.COMPONENT_RESIZE",g)}e.containerResize()},false);this.swatchContainer.addEventListener("transitionend",function(g){e.resizeSwatches()},false);document.addEventListener("DOMNodeRemoved",function(h){if(h.target instanceof HTMLElement){var g=h.target.getElementsByClassName("vfdp-s7-viewer");if(g.length){[].forEach.call(g,function(i){if(i===e.element){e.destroy()}})}}});var f=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver||false;if(f){this.observer=new f(function(g){g.forEach(function(h){e.onConfigChange()})});this.observer.observe(this.element,{attributes:true})}else{this.element.addEventListener("DOMAttrModified",function(g){e.onConfigChange()},false);this.element.addEventListener("onpropertychange",function(g){e.onConfigChange()},false)}}},removeEventHandlers:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.removeEventHandlers")}if(this.observer){this.observer.disconnect()}},onWindowResize:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("VFDPS7Viewer.prototype.onWindowResize")}this.containerResize();var e=a.getScreenSize();if(e!==this.currentSize){this.currentSize=e;this.updateSwatches();this.updateViewer();this.updateIndicator()}},updateIndicator:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("VFDPS7Viewer.prototype.updateIndicator")}var e=this.SetIndicator&&!this.config.getMode("setIndicator"),g=this.config.getMode("setIndicator"),f=!this.SetIndicator&&this.config.getMode("setIndicator");if(e){this.SetIndicator.hide()}if(f){this.initSetIndicator();return}if(g){this.SetIndicator.show()}},onMediaSetParsed:function(e){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.onMediaSetParsed",e)}this.mediasetDesc=e.s7event.asset;this.initViewer();if(this.config.getMode("swatches")){this.initSwatches()}if(this.config.getMode("setIndicator")){this.initSetIndicator()}},onClickFullScreen:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.CONFIG){console.log("VFDPS7Viewer.prototype.onClickFullScreen")}var e=this;if(this.ViewerContainer.isFullScreen()){this.ViewerContainer.cancelFullScreen()}else{this.ViewerContainer.requestFullScreen()}setTimeout(function(){e.containerResize()},250)},swatchSelected:function(e){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.swatchSelected",e)}this.updateCurrentView(e.s7event.asset);this.setViewerActiveIndex(this.Swatches.getFrame())},indicatorPageChange:function(f){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.setIndicatorChanged",f)}var e=f.target.getAttribute("pagenumber");this.setViewerActiveIndex(e);this.SetIndicator.setSelectedPage(e);this.updateCurrentView(this.mediasetDesc.items[e])},setSelectedIndicator:function(e){if(this.SetIndicator){this.SetIndicator.setSelectedPage(e)}},setSwatchPage:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINE){console.log("VFDPS7Viewer.prototype.setSwatchPage",event)}var f=Math.floor(this.Swatches.getFrame()/this.Swatches.component.fitCols_)+1,e=Math.floor(this.Swatches.getFrame()/this.Swatches.component.fitRows_)+1;this.Swatches.setCurrentPage({x:f,y:e})},containerResize:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("VFDPS7Viewer.prototype.containerResize")}if(this.Container.getWidth()>0&&this.Container.getHeight()>0){var f=this.Container.getComponent().obj.getBoundingClientRect().width;var e=this.Container.getComponent().obj.getBoundingClientRect().height;this.resizeViewer(Math.floor(f),Math.floor(e));this.resizeSwatches();this.resizeIndicators()}},resizeViewer:function(f,e){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("VFDPS7Viewer.prototype.containerResize",f,e)}if(f<=0||e<=0){return}a.map(this.Viewer,function(g){g.resize(f,e)})},resizeSwatches:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("VFDPS7Viewer.prototype.resizeSwatches")}if(this.Swatches&&this.config.getMode("swatches")){var f=this.Swatches.getContainer().offsetWidth;var e=this.Swatches.getContainer().offsetHeight;if(this.currentSwatchWidth!=f||this.currentSwatchHeight!=e){this.currentSwatchWidth=f;this.currentSwatchHeight=e;this.Swatches.resize(f,e)}}},resizeIndicators:function(){if(s7sdk.Logger.traceLevel>=s7sdk.Logger.FINEST){console.log("VFDPS7Viewer.prototype.resizeIndicators")}var g,e,f=this.SetIndicator?document.getElementById(this.SetIndicator.compId):null;if(!f){return}if(this.SetIndicator&&this.config.getMode("setIndicator")){g=this.setIndicatorContainer.getBoundingClientRect().width;e=this.setIndicatorContainer.getBoundingClientRect().height;if(this.currentIndicatorWidth!=g||this.currentIndicatoreight!=e){this.currentIndicatorWidth=g;this.currentIndicatoreight=e;this.SetIndicator.restrictedStylesValues.s7setindicator.width=Math.floor(g);this.SetIndicator.restrictedStylesValues.s7setindicator.height=Math.floor(e);f.style.width=Math.floor(g)+"px";f.style.height=Math.floor(e)+"px"}}},fadeOutPreloadedImage:function(){this.element.querySelectorAll("#"+this.viewerContainer.id)[0].className+=" fade-in";this.element.getElementsByClassName("vfdp-s7-viewer-preload-container")[0].className+=" fade-out";if(this.config.getMode("swatches")){this.swatchContainer.className+=" fade-in"}else{if(this.config.getMode("setIndicator")){this.element.getElementsByClassName("vfdp-s7-viewer-preload-container")[0].className+=" hidden"}else{var e=this.element.getElementsByClassName("viewer-wrapper")[0],f=e.className;e.className=f.replace(/(^|\s)alt-image-\S+/,"")}}},onConfigChange:function(){var e=JSON.parse(this.element.getAttribute("data-viewer-options"));if(e){this.config.setConfig(e);this.updateMediaSet();this.updateViewer();this.updateMediaSetIndex();this.updateSwatches();this.updateIndicator()}}};return function(){var e=document.getElementsByClassName("vfdp-s7-viewer");[].forEach.call(e,function(f){new c(f,SCENE7.VIEWER_CONFIG||{})})}});