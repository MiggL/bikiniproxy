define(["jquery","wcs.context","pubsub"],function(f,b){var d="wcsproductPrices";var c=false;var e=function(j,h){var g;if(f(j).is(".product-form-js")){g=f(j)}else{g=f(j).find(".product-form-js")}this.$productForm=g;this._isColorBundle=null;this._isProductBundle=null;this._bundlePartNumber=null;this._productId=[];this._attrId=[];this._itemPricingJSONCache=window.itemPrices||{};this._isBuyable=[];this._possibleProducts=[];this._isListenersSet=false;this._isInitialized=false;this._lastClickedElement=null;this._fetchQueue=[];this._fetchPointer=0;this._retryCount=[];this._firstLoad=WCS_CONFIG.get("PDP::ignoreSelectionOnFirstLoad");this.DEFAULT_RETRY_COUNT=5;this.productCandidates=[];this.price=null;this.listPrice=null;this.lowPrice=null;this.highPrice=null;this.lowListPrice=null;this.highListPrice=null;this.lowPriceNumeric=0;this.highPriceNumeric=0;this.lowListPriceNumeric=0;this.highListPriceNumeric=0;this.options=h;this.metadata=this.$productForm.data("product-pricing-options");this.productFormIndex=f(".product-form-js").index(this.$productForm)};e.prototype={defaults:{},init:function(){console.log("Initializing WCS Product Pricing");var g=this;g.config=f.extend({},g.defaults,g.options,g.metadata);g._isColorBundle=g.$productForm.find(".selection-js [data-product-id]").length||f(".context-trigger-js").length!==0;g._bundlePartNumber=g.$productForm.data("bundle-part-number")||null;g._isProductBundle=g._multipleProductFormsPresent=f(".product-form-js").length>1;g._initPubSubEvents();return g},_getProductIdFromURLParameter:function(){if(c){console.log("_getProductIdFromURLParameter")}return b.getParameterByName("productId")},_parseProductFormAttributes:function(){if(c){console.log("_parseProductFormAttributes")}var g=this;g.$productForm.each(function(h){var k=f(this),j=g._getProductPriceContainer(h);g._productId[h]=k.find("input[name=catEntryId]").val();g._attrId[h]=k.find("input[name=attrName]").val();g._possibleProducts[h]=[];g._isBuyable[h]=true;g._retryCount[h]=g.DEFAULT_RETRY_COUNT;if(j.length){g._handleItemPricing(h,g._productId[h])}});return this},_initPubSubEvents:function(){if(c){console.log("_initPubSubEvents")}var g=this;f.pubsub("unsubscribe",this.newColorwayProductEventToken);f.pubsub("unsubscribe",this.productFormAttributeMouseLeaveToken);f.pubsub("unsubscribe",this.productFormAttributeChangeCompleteEventToken);this.newColorwayProductEventToken=f.pubsub("subscribe","WCS.PRODUCTFORM.COLORWAY_PRODUCT.NEW",function(j,h){if(h.formIndex===g.productFormIndex){g.init()}});this.productFormAttributeMouseLeaveToken=f.pubsub("subscribe","WCS.PRODUCTFORM.EVENT.ATTR.MOUSE.LEAVE",function(j,h){g.attrBoxMouseLeaveHandler(h)});this.productFormAttributeChangeCompleteEventToken=f.pubsub("subscribe","WCS.PRODUCTFORM.ATTRIBUTE.CHANGE.COMPLETE",function(j,h){g._resolveAttributeSelections(h.obj)});this.productFormPreselectedValuesInitEventToken=f.pubsub("subscribe","WCS.PRODUCTFORM.PRESELECTED_VALUES.INIT",function(j,h){f.pubsub("unsubscribe",g.productFormPreselectedValuesInitEventToken);if(h){g._parseProductFormAttributes()._resolveAttributeSelections()}else{g._parseProductFormAttributes()}})},reset:function(){if(c){console.log("reset")}this._isInitialized=false;this._firstLoad=WCS_CONFIG.get("PDP::ignoreSelectionOnFirstLoad")},_getPricingByProductID:function(h,j){if(c){console.log("_getPricingByProductID")}var g=this,k=this.$productForm.data("price-url");if((typeof k!=="undefined")&&(j!="undefined")){f.ajax({url:b.getURLWithContextRoot(k),data:{storeId:b.getStoreId(),langId:b.getLangId(),catalogId:b.getCatalogId(),productId:j}}).done(function(l){g._handleSuccessDataReturn(h,j,l)}).fail(function(){g._handleErrorReturn(h,j)})}},_handleSuccessDataReturn:function(h,j,k){if(c){console.log("_handleSuccessDataReturn")}var g=this;if(k===""){g._handleErrorReturn(h,j)}g._itemPricingJSONCache[j]=k;g._handleItemPricing(h,j)},_handleErrorReturn:function(h,j){if(c){console.log("_handleErrorReturn")}var g=this;if(g._retryCount[h]===0){return true}else{g._retryCount[h]--;g._getPricingByProductID(h,j)}},_handleItemPricing:function(h,j){if(c){console.log("_handleItemPricing")}var g=this,k;if(!g._itemPricingJSONCache.hasOwnProperty(j)){g._getPricingByProductID(h,j);return}else{k=g._itemPricingJSONCache[j]}g._isInitialized=true;if(typeof k.buyable!=="undefined"){g._isBuyable[h]=k.buyable}if(g._isBuyable[h]===true){g._resetPrice(h)}else{g._showProductPrice(h,null)}if(g._getProductIdFromURLParameter()){g._resetPrice(h)}},_resetPrice:function(h){if(c){console.log("_resetPrice")}var g=this;g._possibleProducts[h]=[];if(g._firstLoad===true){g._firstLoad=false}else{g._getNewAttributeSelections(h)}g._refreshProductPrice(h)},_getNewAttributeSelections:function(h){if(c){console.log("_getNewAttributeSelections")}var g=this;g.$productForm.eq(h).find(".attr-box.selected:visible").each(function(){var k=f(this).data("attribute-value"),j=f(this).closest(".selection-js").data("attribute-id");if(typeof j==="undefined"){j=g._attrId[h]}g.handleAttrInputChange(h,j,k,-1)});g.$productForm.eq(h).find(".attr-input-js option:selected").each(function(){var k=f(this).data("attribute-value"),j=f(this).closest(".selection-js").data("attribute-id");if(typeof j==="undefined"){j=g._attrId[h]}g.handleAttrInputChange(h,j,k,-1)})},_refreshProductPrice:function(h){if(c){console.log("_refreshProductPrice +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")}var g=this,j=g._productId;if(g._possibleProducts[h].length===0){if(typeof g._itemPricingJSONCache[g._productId[h]]!=="undefined"){if(c){console.log("Cached price data exists",g._itemPricingJSONCache,g._productId,h)}g._showProductPrice(h,g._itemPricingJSONCache[j[h]].pricing["default"])}else{if(c){console.warn("Missing cached price data when selecting size context",g._itemPricingJSONCache,g._productId,h)}}}else{if(!g._itemPricingJSONCache[j[h]].pricing){g._showProductPrice(h,null)}else{g.getNewProductPricingData(h)}}},getNewProductPricingData:function(h){if(c){console.log("getNewProductPricingData")}var g=this;g.productCandidates=g._possibleProducts[h][0].sku;for(var j in g._possibleProducts[h]){g.productCandidates=g.arrayIntersection(g.productCandidates,g._possibleProducts[h][j].sku)}if(g.productCandidates.length>0){g._showProductPrice(h,g.buildProductPriceJSONForRenderingPrice(h))}else{g._showProductPrice(h,null)}},buildProductPriceJSONForRenderingPrice:function(o){if(c){console.log("buildProductPriceJSONForRenderingPrice")}var t=this,n={},k=t._productId,g=true;for(var m in t.productCandidates){var l=t.productCandidates[m],s=t._itemPricingJSONCache[k[o]].pricing.sku[l],p=s.price,r=s.priceNumeric,h=s.listPrice,q=s.listPriceNumeric;if(g){g=false;t.lowPrice=p;t.highPrice=p;t.lowListPrice=h;t.highListPrice=h;t.lowPriceNumeric=r;t.highPriceNumeric=r;t.lowListPriceNumeric=q;t.highListPriceNumeric=q}else{if(r<t.lowPriceNumeric){t.lowPriceNumeric=r;t.lowPrice=p}if(r>t.highPriceNumeric){t.highPriceNumeric=r;t.highPrice=p}if(q<t.lowListPriceNumeric){t.lowListPriceNumeric=q;t.lowListPrice=h}if(q>t.highListPriceNumeric){t.highListPriceNumeric=q;t.highListPrice=h}}}n={lowPrice:t.lowPrice,lowPriceNumeric:t.lowPriceNumeric,highPrice:t.highPrice,highPriceNumeric:t.highPriceNumeric,lowListPrice:t.lowListPrice,lowListPriceNumeric:t.lowListPriceNumeric,highListPrice:t.highListPrice,highListPriceNumeric:t.highListPriceNumeric};return n},loadPriceValues:function(j,n){if(c){console.log("loadPriceValues")}var m=new a(j),u,s,p=[],k,l=false;if(typeof n==="undefined"||n===null){m.updatePriceHTML(setToZero=true,undefined);m.hideAllPrices()}else{var o,g,h;if(n.lowPriceNumeric==n.highPriceNumeric){o=n.lowPrice;p[0]=n.lowPriceNumeric}else{if(WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")&&(n.highPriceNumeric===n.highListPriceNumeric)){o=n.lowPrice+" <bdi>- "+n.highPrice+"</bdi>";l=true}else{o=n.lowPrice+" - "+n.highPrice}p[0]=n.lowPriceNumeric;if(WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")&&(n.highPriceNumeric!==n.highListPriceNumeric)){p[1]=n.highPriceNumeric}}if(n.lowListPriceNumeric==n.highListPriceNumeric){g=(n.lowPriceNumeric<=n.lowListPriceNumeric?n.lowListPrice:n.lowPrice);k=(n.lowPriceNumeric<=n.lowListPriceNumeric?n.lowListPriceNumeric:n.lowPriceNumeric)}else{var t=(n.lowPriceNumeric<=n.lowListPriceNumeric?n.lowListPrice:n.lowPrice);var v=(n.highPriceNumeric<=n.highListPriceNumeric?n.highListPrice:n.highPrice);if(t!=v){g=t+" - "+v}else{g=t}if(WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")){k=[];if(n.highPriceNumeric<n.highListPriceNumeric){k[0]=n.lowListPriceNumeric;k[1]=n.highListPriceNumeric}else{k[0]=n.lowListPriceNumeric}}}h=n.lowPriceNumeric;m.setDataAmount(h);if(WCS_CONFIG.get("grid::productShowDiscountPercentage")===true){if(o!=g){u=0;s=0;var r,q=0;if(o.indexOf("-")>-1){u=o.split("-");s=u[0].trim();q=s.match(/\d+([\/.]\d+)?/g);q=parseFloat(q[0])}r=g.match(/\d+([\/.]\d+)?/g);r=parseFloat(r[0]);if(q>=r){m.updatePriceHTML(setToZero=true,o)}else{m.showSalePrice(g,o,p,k,l)}}else{if(o==g){m.updatePriceHTML(setToZero=false,o)}else{m.updatePriceHTML(setToZero=true,undefined)}}}else{if(o!=g){u=0;s=0;if(o.indexOf("-")>-1){u=o.split("-");s=u[0].trim()}if(s>=g){m.updatePriceHTML(setToZero=true,o)}else{m.showSalePrice(g,o)}}else{if(o==g){m.updatePriceHTML(setToZero=false,o)}else{m.updatePriceHTML(setToZero=true,undefined)}}}}},_showProductPrice:function(j,g){if(c){console.log("_showProductPrice")}var h=this,l="",k=h._getProductPriceContainer(j);h.loadPriceValues(k,g);if(WCS_CONFIG.get("PDP::showPriceAboveAddToCart")===true){var m=f(".product-actions-product-price-container .product-price-js").eq(0);h.loadPriceValues(m,g)}},_getProductPriceContainer:function(h){if(c){console.log("_getProductPriceContainer")}var g=this;if(g._isProductBundle){return f(".price-container-js").eq(h).find("> .product-price-js")}else{return f("#product-info .product-price-js, .price-container-js .product-price-js").eq(h)}},findElementByIndex:function(k,g,j){if(c){console.log("findElementByIndex")}for(var h in k){if(k[h][g]==j){return h}}return -1},arrayIntersection:function(h,g){if(c){console.log("arrayIntersection")}var k=[];for(var j in h){if(g.indexOf(h[j])>-1){k.push(h[j])}}return k},_resolveAttributeSelections:function(k){if(c){console.log("_resolveAttributeSelections")}var g=this;k=k||g.$productForm.find(".clicked.selected").first();if(k.parents(".qty-step-js").length>0){return true}else{if(g._isInitialized){var j=f(".product-form-js").index(g.$productForm),h=k.parents(".attr-container-js").find(".selected [data-product-id]").data("product-id")||(k.hasClass("clicked")&&k.data("product-id"));if(g._isBuyable[j]!==true){g._showProductPrice(j,null);return true}if(g._isColorBundle&&h){g._productId[j]=h;if(g._itemPricingJSONCache[g._productId[j]]){g._handleItemPricing(j,g._productId[j])}else{g._possibleProducts[j]=[];g._parseProductFormAttributes()}}else{g._resetPrice(j)}}}},attrBoxMouseLeaveHandler:function(g){if(c){console.log("attrBoxMouseLeaveHandler")}var h=this;if(h._isInitialized){var j=h.$productForm.index(g.closest(".product-form-js"));if(h._isBuyable[j]===true){h._resetPrice(j)}else{h._showProductPrice(j,null)}}},handleAttrInputChange:function(j,m,n,k){if(c){console.log("handleAttrInputChange")}var h=this,l=h._productId;if(typeof n==="undefined"&&k>-1){if(k===0&&h._possibleProducts[j].length===1){h._possibleProducts[j]=[]}else{if(k===0){h._possibleProducts[j][k].sku=h._possibleProducts[j][1].sku}else{h._possibleProducts[j][k].sku=h._possibleProducts[j][0].sku}}}else{if(typeof n!=="undefined"){var g=[];if(typeof h._itemPricingJSONCache[h._productId[j]]!=="undefined"){if(typeof h._itemPricingJSONCache[h._productId[j]].pricing[m]==="undefined"){if(typeof h._itemPricingJSONCache[h._productId[j]].pricing.sku!=="undefined"){f.each(h._itemPricingJSONCache[h._productId[j]].pricing.sku,function(p,o){g.push(parseInt(p))})}}else{if(typeof h._itemPricingJSONCache[h._productId[j]].pricing[m][n]!=="undefined"){g=h._itemPricingJSONCache[h._productId[j]].pricing[m][n].sku}}if(k<0){h._possibleProducts[j].push({attrId:m,sku:g})}else{h._possibleProducts[j][k].sku=g}}}}}};var a=function(g){if(!(this instanceof a)){return new a(g)}this.priceContainer=g;this.$price=g.find(".product-price-amount-js");this.$priceOri=g.find(".original-price-js");this.$priceCur=g.find(".current-price-js");if(WCS_CONFIG.get("grid::productShowDiscountPercentage")===true){this.$priceDis=g.find(".discount-price-js")}this.wasText=this.$priceOri.data("text");this.nowText=this.$priceCur.data("text")};a.prototype={init:function(){var g=this;return g},setDataAmount:function(g){if(c){console.log("setDataAmount")}this.$price.data("amount",g)},setPriceContainer:function(g){if(c){console.log("setPriceContainer")}this.priceContainer=g},getPriceContainer:function(){if(c){console.log("getPriceContainer")}return this.priceContainer},hideAllPrices:function(){if(c){console.log("hideAllPrices")}this.$price.hide();this.$priceOri.hide();this.$priceCur.hide();if(WCS_CONFIG.get("grid::productShowDiscountPercentage")===true){this.$priceDis.hide()}},showSalePrice:function(g,h,k,m,l){if(c){console.log("showSalePrice")}if(WCS_CONFIG.get("grid::productShowDiscountPercentage")===true){var j;j=this.getDiscountPercentage(k,m);this.$priceDis.html(j);this.$priceDis.show()}this.$priceOri.html(this.wasText+" "+g);this.$priceCur.html(this.nowText+" "+h);this.$price.html("");this.$price.hide();if(WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")&&l){this.$priceOri.hide()}else{this.$priceOri.show()}this.$priceCur.show();if(WCS_CONFIG.get("grid::productShowDiscountPercentage")===true){this.$priceDis.show()}},getDiscountPercentage:function(k,m){var j,l=k.length;if(l<=1){j=this.calculateDiscount(k[0],m)+"%"}else{if(WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")){var h,g;if(f.isArray(m)){h=this.calculateDiscount(k[0],m[0])+"%";if(m.length>1){g=this.calculateDiscount(k[1],m[1])+"%";j=h+" - "+g}else{j=h}}else{h=this.calculateDiscount(k[0],m)+"%";g=this.calculateDiscount(k[1],m)+"%";j=(k[0]<k[1]?j=g+" - "+h:j=h+" - "+g)}}else{for(i=0;i<k.length;i++){k[i]=Math.round((((k[i]-m)*100)/m))+"%"}j=k[1]+" - "+k[0]}}if(WCS_CONFIG.get("PDP::pdpDisplayBracketInDiscountPercent")===true){j="["+j+"]"}return j},calculateDiscount:function(h,j){var g=Math.round(((h-j)*100/j))||0;return g},updatePriceHTML:function(h,g){if(c){console.log("updatePriceHTML")}if(h){this.$price.data("amount",0)}if(g){this.$price.html(g);this.$price.show()}else{this.$price.html("");this.$price.show()}this.$priceOri.html("");this.$priceCur.html("");if(this.$priceDis){this.$priceDis.hide()}f.pubsub("publish","product.price.updated",g)}};e.defaults=e.prototype.defaults;f.fn.productPrices=function(g){return this.each(function(){var h=f(this).data(d);if(!h){h=new e(this,g).init();f(this).data(d,h)}})}});