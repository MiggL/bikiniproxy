define(["jquery","wcs.context"],function(e,a){var b=false;var d="storeFavCookie";var c=function(g,f){this.element=g;this.options=f};c.prototype={defaults:{},init:function(){var f=this;f._retrieveStoreList(true);return f},_getGeoLocationCookie:function(){if(b){console.log("BOPISSTORE - _getGeoLocationCookie")}return a.getCookie("Edgescape-Lat-Long")},_getZipLocationCookie:function(){if(b){console.log("BOPISSTORE - _getZipLocationCookie")}return a.getCookie("Edgescape-Zip")},_getFavCookie:function(){if(b){console.log("BOPISSTORE - _getStoreFavCookie")}var g=WCS_CONFIG.get("BOPIS::bopisFavStore")+a.getStoreId(),f=a.getCookie(g);if(f!==null&&f!==undefined){return f}return undefined},_retrieveStoreList:function(i){var t=this,n=e.Deferred(),s="^(\\+|\\-)?[0-9]+(.[0-9]+)?$",h=WCS_CONFIG.get("BOPIS::w2giServerApiEnabled");if(b){console.log("BOPISSTORE - _retrieveStoreList")}if(t._getGeoLocationCookie()!==null&&t._getGeoLocationCookie()!==undefined){if(t._getFavCookie()===undefined){if(h){var k=WCS_CONFIG.get("BOPIS::w2giServerApiURL"),m=WCS_CONFIG.get("BOPIS::w2giMaxRadius"),p=t._getGeoLocationCookie()?t._getGeoLocationCookie():"",o=t._getZipLocationCookie()?t._getZipLocationCookie().split("-")[0]:"",r=p.split(","),g={radius:m};if(i&&o!==""){g.addressLine=o}else{if(i&&r.length>1&&r[0].match(s)&&r[1].match(s)){g.latLong=p}else{g.addressLine=""}}e.ajax({type:"GET",url:k,dataType:"xml",data:g,}).done(function(u){u=t._processDataForCookie(u);n.resolve(u)}).fail(function(u){console.error(u)})}else{var l=t._getQueryXMLURL(i).split("?"),f=l[0],j=l[1],q=[];e.ajax({type:"POST",url:f,data:j,dataType:"xml"}).done(function(u){u=t._processDataForCookie(u);n.resolve(u)}).fail(function(u){console.error(u)})}return n.promise()}}},_processDataForCookie:function(k){var q=this;if(b){console.log("BOPISSTORE - _processDataForCookie")}var l=e(k),j=l.find("response").attr("code"),h=l.find("poi"),o="",g="",n=[],f=[],i;n=q._buildESI(h);f=q._buildpostalCode(h);o=n[0];g=f[0];if(o!==null){var p=WCS_CONFIG.get("BOPIS::bopisFavStore");if(q._getGeoLocationCookie()!==null&&q._getGeoLocationCookie()!==undefined){var m=p+a.getStoreId();a.setCookie(m,o);if(g){a.setCookie("STORE_ZIP_VALUE",g);a.setCookie("USER_ENTERED_ZIP",g)}}}},_buildpostalCode:function(g){var f=[];e(g).each(function(h,i){f.push(e(i).find("postalcode").text())});return f},_buildESI:function(g){var f=[];e(g).each(function(h,i){f.push(e(i).find("enterprise_store_identifier").text())});return f},_getQueryXMLURL:function(g){var r=this;var h=WCS_CONFIG.get("BOPIS::w2giURL"),o=WCS_CONFIG.get("BOPIS::w2giKey"),i=WCS_CONFIG.get("BOPIS::w2giStoreLimit"),f=WCS_CONFIG.get("BOPIS::w2giWhereClauseBrand"),p=WCS_CONFIG.get("BOPIS::w2giMaxRadius"),l=WCS_CONFIG.get("PDP::pdpInStoreW2GICountryCode"),q=r._getGeoLocationCookie()?r._getGeoLocationCookie().split(","):["",""],n=r._getZipLocationCookie()?r._getZipLocationCookie().split("-")[0]:"",m="^(\\+|\\-)?[0-9]+(.[0-9]+)?$",j="<geolocs><geoloc>";if(g&&n!==""){j+="<addressline>"+n+"</addressline>"}else{if(g&&q[0].match(m)&&q[1].match(m)){j+="<longitude>"+q[1]+"</longitude>";j+="<latitude>"+q[0]+"</latitude>"}else{j+="<addressline></addressline>"}}j+="</geoloc></geolocs>";var k="";if(f!==""){k=["<request>","<appkey>"+o+"</appkey>",'<formdata id="locatorsearch">',"<dataview>store_default</dataview>","<order>_distance</order>","<softmatch>1</softmatch>","<limit>"+i+"</limit>","<atleast>1</atleast>","<searchradius>"+p+"</searchradius>",j,"<stateonly>1</stateonly>","<nobf>1</nobf>","<where>","<"+f+"><eq>1</eq></"+f+">","<country><eq>"+l+"</eq></country>","</where>","</formdata></request>"]}else{k=["<request>","<appkey>"+o+"</appkey>",'<formdata id="locatorsearch">',"<dataview>store_default</dataview>","<order>_distance</order>","<softmatch>1</softmatch>","<limit>"+i+"</limit>","<atleast>1</atleast>","<searchradius>"+p+"</searchradius>",j,"<stateonly>1</stateonly>","<nobf>1</nobf>","<where>","<tnvn><eq></eq></tnvn>","<country><eq>"+l+"</eq></country>","<or>","<off><eq>TRUE</eq></off>","<out><eq></eq></out>","<aut><eq></eq></aut>","</or></where></formdata></request>"]}h=h+encodeURIComponent(k.join(""));return h}};c.defaults=c.prototype.defaults;e.fn.storeFavCookie=function(f){return this.each(function(){var g=e(this).data(d);if(!g){g=new c(this,f).init();e(this).data(d,g)}})}});